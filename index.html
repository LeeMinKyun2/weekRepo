<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ê°„ ì—…ë¬´ ë³´ê³ </title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 600px; margin: auto; }
        h1 { text-align: center; color: #333; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea { resize: vertical; min-height: 100px; }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover { background-color: #45a049; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #confirmSiteButton {
            background-color: #2196F3;
            margin-left: 10px;
            padding: 8px 16px;
            font-size: 14px;
        }
        #confirmSiteButton:hover:not(:disabled) { background-color: #1976D2; }
        .response { margin-top: 20px; padding: 10px; background-color: #e2e2e2; border-radius: 4px; }
        
        /* í—¤ë” ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .help-button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .help-button:hover {
            background-color: #1976D2;
        }
        
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #ddd;
            background-color: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #333;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .step {
            display: flex;
            margin-bottom: 20px;
            align-items: flex-start;
        }
        
        .step-number {
            font-size: 24px;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .step-content {
            flex: 1;
            line-height: 1.6;
        }
        
        .step-content strong {
            color: #2196F3;
            font-size: 16px;
        }
        
        .account-info {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            border-left: 4px solid #2196F3;
        }
        
        .account-info h3 {
            margin: 0 0 10px 0;
            color: #1976D2;
        }
        
        .account-info p {
            margin: 5px 0;
            font-family: monospace;
            background-color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
        }
        
        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .header-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .help-button {
                margin-top: 10px;
                align-self: flex-end;
            }
            
            .modal-content {
                width: 95%;
                margin: 5% auto;
                max-height: 90vh;
            }
            
            .modal-header {
                padding: 15px;
            }
            
            .modal-header h2 {
                font-size: 18px;
            }
            
            .modal-body {
                padding: 15px;
            }
            
            .step {
                flex-direction: column;
                text-align: center;
                margin-bottom: 15px;
            }
            
            .step-number {
                margin-right: 0;
                margin-bottom: 8px;
                font-size: 20px;
            }
            
            .step-content {
                font-size: 14px;
            }
            
            .step-content strong {
                font-size: 14px;
            }
            
            .account-info {
                padding: 12px;
                margin-top: 15px;
            }
            
            .account-info h3 {
                font-size: 16px;
            }
            
            .account-info p {
                font-size: 13px;
                padding: 4px 8px;
            }
        }
        
        /* ë§¤ìš° ì‘ì€ í™”ë©´ (320px ì´í•˜) */
        @media (max-width: 480px) {
            .modal-content {
                width: 98%;
                margin: 2% auto;
                max-height: 95vh;
            }
            
            .modal-header {
                padding: 12px;
            }
            
            .modal-header h2 {
                font-size: 16px;
            }
            
            .modal-body {
                padding: 12px;
            }
            
            .step {
                margin-bottom: 12px;
            }
            
            .step-number {
                font-size: 18px;
            }
            
            .step-content {
                font-size: 13px;
            }
            
            .account-info {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-section">
            <h1>ì£¼ê°„ ì—…ë¬´ ë³´ê³  ì…ë ¥</h1>
            <button id="helpButton" class="help-button">ğŸ“– ì‚¬ìš©ë²•</button>
        </div>
        <form id="reportForm">
            <div class="form-group">
                <label for="manager">ë§¤ë‹ˆì € ì´ë¦„:</label>
                <input type="text" id="searchManager" placeholder="ë§¤ë‹ˆì € ì´ë¦„ ê²€ìƒ‰...">
                <select id="manager" name="manager" required>
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>
            <div class="form-group">
                <label for="site_name">ë‹´ë‹¹ ì‚¬ì´íŠ¸:</label>
                <input type="text" id="searchSite" placeholder="ë‹´ë‹¹ ì‚¬ì´íŠ¸ ê²€ìƒ‰...">
                <select id="site_name" name="site_name" required>
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>
            <div class="form-group">
                <label for="reportSheetName">ë³´ê³ ì„œ ì‹œíŠ¸ ì´ë¦„:</label>
                <select id="reportSheetName" name="reportSheetName" required>
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>
            <div class="form-group">
                <button type="button" id="queryDropdownsButton" disabled>ë§¤ë‹ˆì €/ì‚¬ì´íŠ¸ ëª©ë¡ ì¡°íšŒ</button>
                <button type="button" id="confirmSiteButton" disabled>ê³ ì •/ì„ íƒ</button>
            </div>
            <div class="form-group">
                <button type="button" id="readReportButton" disabled>ë³´ê³ ì„œ ì¡°íšŒ</button>
            </div>
            <div class="form-group">
                <label for="this_week_tasks">ê¸ˆì£¼ í•œ ì¼:</label>
                <textarea id="this_week_tasks" name="this_week_tasks" required></textarea>
            </div>
            <div class="form-group">
                <label for="next_week_tasks">ì°¨ì£¼ í•  ì¼:</label>
                <textarea id="next_week_tasks" name="next_week_tasks" required></textarea>
            </div>
            <div class="form-group">
                <label for="customer_requests">ê³ ê° ìš”ì²­ì‚¬í•­:</label>
                <textarea id="customer_requests" name="customer_requests"></textarea>
            </div>
            <button type="submit" disabled>ë³´ê³ ì„œ ì œì¶œ</button>
        </form>
        <div id="response" class="response" style="display: none;"></div>
    </div>

    <!-- ì‚¬ìš©ë²• íŒì—… ëª¨ë‹¬ -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“– ì‚¬ìš©ë²•</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="step">
                    <div class="step-number">1ï¸âƒ£</div>
                    <div class="step-content">
                        <strong>ë§¤ë‹ˆì €/ì‚¬ì´íŠ¸ ëª©ë¡ ì¡°íšŒ</strong><br>
                        "ë§¤ë‹ˆì €/ì‚¬ì´íŠ¸ ëª©ë¡ ì¡°íšŒ" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-number">2ï¸âƒ£</div>
                    <div class="step-content">
                        <strong>ì •ë³´ ì„ íƒ</strong><br>
                        ë§¤ë‹ˆì € ì´ë¦„, ë‹´ë‹¹ ì‚¬ì´íŠ¸, ë³´ê³ ì„œ ì‹œíŠ¸ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-number">3ï¸âƒ£</div>
                    <div class="step-content">
                        <strong>ê³ ì •/ì„ íƒ</strong><br>
                        "ê³ ì •/ì„ íƒ" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì‚¬ì´íŠ¸ë³„ ì„¤ì •ì„ í™•ì¸í•©ë‹ˆë‹¤.
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-number">4ï¸âƒ£</div>
                    <div class="step-content">
                        <strong>ë³´ê³ ì„œ ì œì¶œ</strong><br>
                        í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•œ í›„ "ë³´ê³ ì„œ ì œì¶œ" ë²„íŠ¼ì„ í´ë¦­í•©ë‹ˆë‹¤.
                    </div>
                </div>
                
                <div class="account-info">
                    <h3>ğŸ” Google ê³µìš© ê³„ì •</h3>
                    <p><strong>ID:</strong> interezen502@gmail.com</p>
                    <p><strong>PW:</strong> inter502</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Google API ì„¤ì •
        const CLIENT_ID = '898247770764-ev4i2nonvqnd4n8evrnivt75i2t78s0u.apps.googleusercontent.com'; // Google Cloud Consoleì—ì„œ ë°œê¸‰ë°›ì€ í´ë¼ì´ì–¸íŠ¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.
        const API_KEY = 'AIzaSyBV_qqUNlgCkRAt7sITJbzxt38I3gZ5Z-4';     // Google Cloud Consoleì—ì„œ ë°œê¸‰ë°›ì€ API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
        const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
        const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // ì›ë³¸ ë§¤ë‹ˆì € ë° ì‚¬ì´íŠ¸ ëª©ë¡ (ê²€ìƒ‰ í•„í„°ë§ìš©)
        let originalManagers = [];
        let originalSites = [];
        // ì›ë³¸ ë³´ê³ ì„œ ì‹œíŠ¸ ì´ë¦„ ëª©ë¡ (ê²€ìƒ‰ í•„í„°ë§ìš©)
        let originalReportSheetNames = [];
        
        // L40 ì´í›„ ë²”ìœ„ì˜ ì‚¬ì´íŠ¸ë“¤ (ê³ ê° ìš”ì²­ì‚¬í•­ ì…ë ¥ ë¶ˆê°€) - ë™ì ìœ¼ë¡œ ìƒì„±ë¨
        let sitesWithoutCustomerRequests = [];

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: DISCOVERY_DOCS,
            });
            // Sheets APIë¥¼ ëª…ì‹œì ìœ¼ë¡œ ë¡œë“œí•©ë‹ˆë‹¤.
            await gapi.client.load('sheets', 'v4');
            gapiInited = true;
            maybeEnableForm();
        }

        function gisLoaded() {
            console.log('ğŸ”§ GIS (Google Identity Services) ë¡œë“œë¨');
            console.log('ğŸ”§ CLIENT_ID:', CLIENT_ID);
            console.log('ğŸ”§ SCOPES:', SCOPES);
            console.log('ğŸ”§ í˜„ì¬ URL:', window.location.href);
            console.log('ğŸ”§ í˜„ì¬ Origin:', window.location.origin);
            
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (resp) => {
                    console.log('ğŸ”§ OAuth ì½œë°± ì‘ë‹µ:', resp);
                    if (resp.error !== undefined) {
                        console.error('âŒ OAuth ì˜¤ë¥˜:', resp.error);
                        console.error('âŒ ì˜¤ë¥˜ ìƒì„¸:', resp.error_description);
                        console.error('âŒ ì „ì²´ ì‘ë‹µ:', resp);
                        throw (resp);
                    }
                    console.log('âœ… OAuth ì„±ê³µ, í† í° ì„¤ì •');
                    gapi.client.setToken(resp);
                },
            });
            gisInited = true; // ì´ ë¶€ë¶„ì„ callback ë°–ìœ¼ë¡œ ì´ë™
            maybeEnableForm(); // ì´ ë¶€ë¶„ì„ callback ë°–ìœ¼ë¡œ ì´ë™
        }

        function maybeEnableForm() {
            console.log('maybeEnableForm called.'); // maybeEnableForm í•¨ìˆ˜ í˜¸ì¶œ ë¡œê·¸ ì¶”ê°€
            console.log('gapiInited:', gapiInited, 'gisInited:', gisInited); // gapiInited, gisInited ìƒíƒœ ë¡œê·¸ ì¶”ê°€
            if (gapiInited && gisInited) {
                // í¼ì„ í™œì„±í™”í•˜ê³  ë“œë¡­ë‹¤ìš´ ë°ì´í„°ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.
                // populateDropdowns()ëŠ” ì´ì œ ì¡°íšŒ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë©ë‹ˆë‹¤.
                document.getElementById('queryDropdownsButton').disabled = false;
                document.querySelector('button[type="submit"]').disabled = false;
                console.log('Dropdowns and Submit buttons enabled.'); // ë²„íŠ¼ í™œì„±í™” ë¡œê·¸ ì¶”ê°€
                updateReadReportButtonState(); // ì´ˆê¸° ë¡œë“œ ì‹œ ë³´ê³ ì„œ ì¡°íšŒ ë²„íŠ¼ ìƒíƒœ ì„¤ì •
                updateConfirmSiteButtonState(); // ì´ˆê¸° ë¡œë“œ ì‹œ "ê³ ì •/ì„ íƒ" ë²„íŠ¼ ìƒíƒœ ì„¤ì •
            } else {
                console.log('Dropdowns and Submit buttons NOT yet enabled (waiting for gapi/gis init).'); // ë²„íŠ¼ ë¹„í™œì„±í™” ìƒíƒœ ë¡œê·¸ ì¶”ê°€
            }
        }

        async function populateDropdowns() {
            console.log('ğŸ”§ populateDropdowns í•¨ìˆ˜ ì‹œì‘');
            console.log('ğŸ”§ gapi.client ìƒíƒœ:', gapi.client);
            console.log('ğŸ”§ í˜„ì¬ í† í°:', gapi.client.getToken());
            const managerSelect = document.getElementById('manager');
            const siteSelect = document.getElementById('site_name');
            const reportSheetNameSelect = document.getElementById('reportSheetName');
            const queryButton = document.getElementById('queryDropdownsButton');

            // ë²„íŠ¼ ìƒíƒœë¥¼ ë¡œë”© ì¤‘ìœ¼ë¡œ ë³€ê²½
            queryButton.textContent = 'ë¡œë”© ì¤‘...';
            queryButton.style.backgroundColor = '#ffc107'; // ë¡œë”© ì¤‘ ìƒ‰ìƒ (ì˜ˆ: ì£¼í™©ìƒ‰)
            queryButton.disabled = true;

            // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ 'ì„ íƒí•˜ì„¸ìš”' ì˜µì…˜ ì œì™¸)
            managerSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            siteSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            reportSheetNameSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';

            const SPREADSHEET_ID = '1Xrz9RlDXu3v6pBbuQc-B306gtXnG5CfebRG6KP44Kxs'; // ì œê³µëœ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID
            const DROPDOWN_SHEET_NAME = 'SITE ë¶„ì¥ í˜„í™©'; // ë“œë¡­ë‹¤ìš´ ë°ì´í„°ê°€ ìˆëŠ” ì‹œíŠ¸ ì´ë¦„
            const DROPDOWN_RANGE = `${DROPDOWN_SHEET_NAME}!A:Z`; // ì¶©ë¶„íˆ ë„“ì€ ë²”ìœ„ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤ã€‚

            try {
                console.log('Requesting dropdown data from Google Sheets API...');
                console.log('Spreadsheet ID:', SPREADSHEET_ID);
                console.log('Range:', DROPDOWN_RANGE);

                // ë“œë¡­ë‹¤ìš´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: DROPDOWN_RANGE,
                });

                console.log('Google Sheets API Response (Dropdown Data):', response); // API ì‘ë‹µ ì¶œë ¥

                const sheetData = response.result.values || [];
                console.log('Extracted sheetData:', sheetData); // ì¶”ì¶œëœ sheetData ì¶œë ¥

                const managers = new Set();
                const sites = new Set();

                // 'ì„±ëª…' í—¤ë”ê°€ ìˆëŠ” í–‰ì„ ê±´ë„ˆë›°ê³  ì‹¤ì œ ë°ì´í„°ê°€ ì‹œì‘í•˜ëŠ” í–‰ë¶€í„° ì²˜ë¦¬
                for (let r = 0; r < sheetData.length; r++) {
                    const rowData = sheetData[r] || [];
                    const managerCell = rowData[1] ? rowData[1].trim() : ''; // Column B (index 1) for manager names

                    if (managerCell && managerCell !== 'ì„±ëª…') {
                        managers.add(managerCell);
                    }

                    // Sites start from Column E (index 4)
                    for (let c = 4; c < rowData.length; c++) {
                        const siteCell = rowData[c] ? rowData[c].trim() : '';
                        if (siteCell !== '') {
                            sites.add(siteCell);
                        }
                    }
                }

                originalManagers = Array.from(managers).sort();
                // originalSites = Array.from(sites).sort(); // SITE ë¶„ì¥ í˜„í™©ì—ì„œ ì‚¬ì´íŠ¸ ê°€ì ¸ì˜¤ëŠ” ë¡œì§ ì£¼ì„ ì²˜ë¦¬
                console.log('Original Managers:', originalManagers); // ì›ë³¸ ë§¤ë‹ˆì € ëª©ë¡ ì¶œë ¥
                // console.log('Original Sites:', originalSites);     // ì›ë³¸ ì‚¬ì´íŠ¸ ëª©ë¡ ì¶œë ¥ (ì„ì‹œ ì£¼ì„ ì²˜ë¦¬)

                // ë§¤ë‹ˆì € ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
                updateManagerDropdown(originalManagers);

                // ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë©”íƒ€ë°ì´í„° ê°€ì ¸ì™€ì„œ YYYY-MM-DD í˜•ì‹ì˜ ì‹œíŠ¸ ì´ë¦„ ì°¾ê¸°
                console.log('Requesting spreadsheet metadata...');
                const spreadsheetMetadataResponse = await gapi.client.sheets.spreadsheets.get({
                    spreadsheetId: SPREADSHEET_ID,
                });
                console.log('Google Sheets API Response (Spreadsheet Metadata):', spreadsheetMetadataResponse);

                // YYYY-MM-DD í˜•ì‹ì˜ ì‹œíŠ¸ ì´ë¦„ í•„í„°ë§
                const datePattern = /^\d{4}-\d{2}-\d{2}$/;
                originalReportSheetNames = spreadsheetMetadataResponse.result.sheets
                    .filter(sheet => datePattern.test(sheet.properties.title))
                    .map(sheet => ({
                        title: sheet.properties.title,
                        id: sheet.properties.sheetId  // sheetId ëŒ€ì‹  idë¡œ ë³€ê²½
                    }))
                    .sort((a, b) => b.title.localeCompare(a.title)); // ìµœì‹  ë‚ ì§œê°€ ë¨¼ì € ì˜¤ë„ë¡ ì •ë ¬

                // ë³´ê³ ì„œ ì‹œíŠ¸ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° ë° ì±„ìš°ê¸°
                console.log('Original Report Sheet Names with IDs:', originalReportSheetNames); // ì›ë³¸ ì‹œíŠ¸ ì´ë¦„ ëª©ë¡ê³¼ ID ì¶œë ¥
                updateReportSheetNameDropdown(originalReportSheetNames);

                // --- ì´ì œ ê°€ì¥ ìµœì‹  YYYY-MM-DD ì‹œíŠ¸ì—ì„œ SITEëª… ê°€ì ¸ì˜¤ê¸° ---
                if (originalReportSheetNames.length > 0) {
                    const latestReportSheetName = originalReportSheetNames[0].title; // ê°€ì¥ ìµœì‹  ì‹œíŠ¸ (ì •ë ¬ë˜ì–´ ìˆìŒ)
                    console.log('Fetching site names from latest report sheet:', latestReportSheetName);

                    // ì‚¬ìš©ì ì œê³µ íŒ¨í„´ì— ë”°ë¥¸ SITEëª… ì…€ ë²”ìœ„ (ì „ì²´ ë²”ìœ„ë¡œ í™•ì¥)
                    const siteNameRanges = [
                        `'${latestReportSheetName}'!B:B`, // Bì—´ ì „ì²´ì—ì„œ SITEëª… ì°¾ê¸°
                        `'${latestReportSheetName}'!G:G`, // Gì—´ ì „ì²´ì—ì„œ SITEëª… ì°¾ê¸°
                        `'${latestReportSheetName}'!L:L`, // Lì—´ ì „ì²´ì—ì„œ SITEëª… ì°¾ê¸°
                    ];

                    try {
                        const siteResponse = await gapi.client.sheets.spreadsheets.values.batchGet({
                            spreadsheetId: SPREADSHEET_ID,
                            ranges: siteNameRanges,
                        });
                        console.log('Site Names Batch Get Response:', siteResponse);

                        const fetchedSites = new Set();
                        const lColumnSitesWithoutCustomerRequests = new Set(); // Lì—´ì˜ 40í–‰ ì´í›„ ì‚¬ì´íŠ¸ë“¤
                        
                        siteResponse.result.valueRanges.forEach((rangeData, rangeIndex) => {
                            if (rangeData.values) {
                                rangeData.values.forEach((row, rowIndex) => {
                                    if (row.length > 0 && row[0] && row[0].trim() !== '') {
                                        const cellValue = row[0].trim();
                                        // í—¤ë”ë‚˜ ì„¤ëª… í…ìŠ¤íŠ¸ê°€ ì•„ë‹Œ ì‹¤ì œ ì‚¬ì´íŠ¸ëª…ë§Œ í•„í„°ë§
                                        if (cellValue !== 'SITEëª…' && 
                                            !cellValue.includes('ê¸ˆì£¼ í•œ ì¼') && 
                                            !cellValue.includes('ì°¨ì£¼ í•  ì¼') && 
                                            !cellValue.includes('ê³ ê° ìš”ì²­ì‚¬í•­') &&
                                            !cellValue.includes('ë³¸ì¸ ì„±ëª…') &&
                                            !cellValue.includes('í•„ìˆ˜ ì…ë ¥') &&
                                            !cellValue.includes('ì—†ìŒ') &&
                                            !cellValue.includes('â–¶') &&
                                            !cellValue.includes('êµ¬ë¶„') &&
                                            !cellValue.includes('ì‘ì„± ë“±ë¡ì¼') &&
                                            !cellValue.includes('ë§¤ì£¼ ëª©ìš”ì¼') &&
                                            !cellValue.includes('íœ´ì¼ì€ ì „ì¼') &&
                                            !cellValue.includes('ê° í•­ëª©') &&
                                            !cellValue.includes('ì‘ì„± ë‚´ìš©ì´ ì—†ìœ¼ë©´') &&
                                            !cellValue.includes('SITEëª… ìˆœì„œ') &&
                                            !cellValue.includes('í”„ë¡œì íŠ¸ ìˆœ í‘œì‹œ') &&
                                            !cellValue.includes('25ë…„ í˜„ì¬') &&
                                            !cellValue.includes('ì¶”ì§„ ä¸­ í”„ë¡œì íŠ¸') &&
                                            rowIndex >= 3) { // 4í–‰ë¶€í„° ì‹œì‘ (0-basedì´ë¯€ë¡œ 3)
                                            
                                            fetchedSites.add(cellValue);
                                            
                                            // Lì—´(rangeIndex === 2)ì´ê³  40í–‰ ì´í›„(rowIndex >= 39, 0-basedì´ë¯€ë¡œ 40í–‰ì€ 39)ì¸ ê²½ìš°
                                            if (rangeIndex === 2 && rowIndex >= 39) {
                                                lColumnSitesWithoutCustomerRequests.add(cellValue);
                                                console.log(`Lì—´ 40í–‰ ì´í›„ ì‚¬ì´íŠ¸ ë°œê²¬: ${cellValue} (í–‰: ${rowIndex + 1})`);
                                            }
                                        }
                                    }
                                });
                            }
                        });
                        
                        // Lì—´ 40í–‰ ì´í›„ ì‚¬ì´íŠ¸ë“¤ì„ ì˜ˆì™¸ ëª©ë¡ì— ì¶”ê°€
                        sitesWithoutCustomerRequests = Array.from(lColumnSitesWithoutCustomerRequests);
                        console.log('ë™ì ìœ¼ë¡œ ìƒì„±ëœ ì˜ˆì™¸ ì‚¬ì´íŠ¸ ëª©ë¡:', sitesWithoutCustomerRequests);
                        originalSites = Array.from(fetchedSites).sort();
                        console.log('Original Sites from latest report sheet:', originalSites); // ìƒˆë¡œ ê°€ì ¸ì˜¨ ì‚¬ì´íŠ¸ ëª©ë¡ ì¶œë ¥

                    } catch (siteErr) {
                        console.error('Error fetching site names from latest report sheet:', siteErr);
                        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì‚¬ì´íŠ¸ ëª©ë¡ì„ ë¹„ì›Œë‘ 
                        originalSites = [];
                    }
                } else {
                    console.log('No YYYY-MM-DD report sheets found, cannot fetch site names.');
                    originalSites = [];
                }

                // ì‚¬ì´íŠ¸ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
                updateSiteDropdown(originalSites, document.getElementById('searchSite').value);
                
                // ì´ˆê¸° ìƒíƒœì—ì„œ ê³ ê° ìš”ì²­ì‚¬í•­ í•„ë“œ ìƒíƒœ ì„¤ì •
                toggleCustomerRequestsField('');
                
                // ì´ˆê¸° ìƒíƒœì—ì„œ "ê³ ì •/ì„ íƒ" ë²„íŠ¼ ìƒíƒœ ì„¤ì •
                updateConfirmSiteButtonState();

                // Google Sheets ë§í¬ ìƒì„± (ì „ì²´ ìŠ¤í”„ë ˆë“œì‹œíŠ¸)
                const mainSheetUrl = 'https://docs.google.com/spreadsheets/d/1Xrz9RlDXu3v6pBbuQc-B306gtXnG5CfebRG6KP44Kxs/edit';
                document.getElementById('response').innerHTML = `
                    ë§¤ë‹ˆì €/ì‚¬ì´íŠ¸/ì‹œíŠ¸ ëª©ë¡ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.<br>
                    <a href="${mainSheetUrl}" target="_blank" style="color: #1976d2; text-decoration: underline; margin-top: 10px; display: inline-block;">
                        ğŸ“Š Google Sheetsì—ì„œ í™•ì¸í•˜ê¸°
                    </a>
                `;
                document.getElementById('response').style.display = 'block';

                // ë“œë¡­ë‹¤ìš´ ì¡°íšŒ ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                queryButton.textContent = 'ì¡°íšŒ ì™„ë£Œ';
                queryButton.style.backgroundColor = '#6c757d'; // íšŒìƒ‰ ê³„ì—´ ìƒ‰ìƒ
                queryButton.disabled = true; // ë²„íŠ¼ ë¹„í™œì„±í™”

            } catch (err) {
                console.error('Error fetching dropdown data (detailed):', err); // ìƒì„¸ ì˜¤ë¥˜ ì¶œë ¥
                document.getElementById('response').textContent = 'ë“œë¡­ë‹¤ìš´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (err.result?.error?.message || err.message || JSON.stringify(err));
                document.getElementById('response').style.display = 'block';

                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë²„íŠ¼ ìƒíƒœë¥¼ ì´ˆê¸°í™”
                const queryButton = document.getElementById('queryDropdownsButton');
                queryButton.textContent = 'ë§¤ë‹ˆì €/ì‚¬ì´íŠ¸ ëª©ë¡ ì¡°íšŒ';
                queryButton.style.backgroundColor = '#4CAF50'; // ì›ë˜ ìƒ‰ìƒ
                queryButton.disabled = false; // ë‹¤ì‹œ í™œì„±í™”
            }
        }

        /**
         * ë§¤ë‹ˆì € ë“œë¡­ë‹¤ìš´ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         * @param {Array<string>} managersList í‘œì‹œí•  ë§¤ë‹ˆì € ëª©ë¡
         */
        function updateManagerDropdown(managersList) {
            console.log('Updating Manager Dropdown with:', managersList); // ë§¤ë‹ˆì € ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ ì „ ëª©ë¡ ì¶œë ¥
            const managerSelect = document.getElementById('manager');
            managerSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>'; // ê¸°ì¡´ ì˜µì…˜ ì œê±°
            managersList.forEach(manager => {
                const option = document.createElement('option');
                option.value = manager;
                option.textContent = manager;
                managerSelect.appendChild(option);
            });
        }

        /**
         * ì‚¬ì´íŠ¸ ë“œë¡­ë‹¤ìš´ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         * @param {Array<string>} sitesList í‘œì‹œí•  ì‚¬ì´íŠ¸ ëª©ë¡
         * @param {string} searchTerm ì‚¬ì´íŠ¸ ê²€ìƒ‰ì–´ (í˜„ì¬ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
         */
        function updateSiteDropdown(sitesList, searchTerm = '') {
            console.log('Updating Site Dropdown with:', sitesList, 'Search Term:', searchTerm); // ì‚¬ì´íŠ¸ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ ì „ ëª©ë¡ ì¶œë ¥
            const siteSelect = document.getElementById('site_name');
            siteSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>'; // ê¸°ì¡´ ì˜µì…˜ ì œê±°

            const filteredSites = sitesList.filter(site =>
                site.toLowerCase().includes(searchTerm.toLowerCase())
            ).sort();

            filteredSites.forEach(site => {
                const option = document.createElement('option');
                option.value = site;
                option.textContent = site;
                siteSelect.appendChild(option);
            });
        }

        /**
         * "ê³ ì •/ì„ íƒ" ë²„íŠ¼ì˜ í™œì„±í™”/ë¹„í™œì„±í™” ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function updateConfirmSiteButtonState() {
            const confirmButton = document.getElementById('confirmSiteButton');
            const managerSelected = document.getElementById('manager').value !== '';
            const siteSelected = document.getElementById('site_name').value !== '';
            const reportSheetSelected = document.getElementById('reportSheetName').value !== '';
            
            if (managerSelected && siteSelected && reportSheetSelected) {
                confirmButton.disabled = false;
                confirmButton.textContent = 'ê³ ì •/ì„ íƒ';
            } else {
                confirmButton.disabled = true;
                confirmButton.textContent = 'ê³ ì •/ì„ íƒ';
            }
        }

        /**
         * ì„ íƒëœ ì‚¬ì´íŠ¸ì— ë”°ë¼ ê³ ê° ìš”ì²­ì‚¬í•­ í•„ë“œë¥¼ í™œì„±í™”/ë¹„í™œì„±í™”í•©ë‹ˆë‹¤.
         * @param {string} selectedSite ì„ íƒëœ ì‚¬ì´íŠ¸ëª…
         */
        function toggleCustomerRequestsField(selectedSite) {
            const customerRequestsField = document.getElementById('customer_requests');
            const customerRequestsLabel = document.querySelector('label[for="customer_requests"]');
            
            console.log('toggleCustomerRequestsField called with:', selectedSite);
            console.log('Checking if site is in exception list...');
            
            if (sitesWithoutCustomerRequests.includes(selectedSite)) {
                // ê³ ê° ìš”ì²­ì‚¬í•­ ì…ë ¥ ë¶ˆê°€ ì‚¬ì´íŠ¸ì¸ ê²½ìš°
                customerRequestsField.disabled = true;
                customerRequestsField.value = ''; // ê¸°ì¡´ ê°’ ì´ˆê¸°í™”
                customerRequestsField.placeholder = 'í•´ë‹¹ ì‚¬ì´íŠ¸ëŠ” ê³ ê° ìš”ì²­ì‚¬í•­ ì…ë ¥ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.';
                customerRequestsField.style.backgroundColor = '#f5f5f5';
                customerRequestsField.style.color = '#999';
                customerRequestsLabel.style.color = '#999';
                customerRequestsLabel.textContent = 'ê³ ê° ìš”ì²­ì‚¬í•­ (ì…ë ¥ ë¶ˆê°€)';
            } else {
                // ì¼ë°˜ ì‚¬ì´íŠ¸ì¸ ê²½ìš°
                customerRequestsField.disabled = false;
                customerRequestsField.placeholder = 'ê³ ê° ìš”ì²­ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš” (ì—†ìœ¼ë©´ "ì—†ìŒ" ì…ë ¥)';
                customerRequestsField.style.backgroundColor = '';
                customerRequestsField.style.color = '';
                customerRequestsLabel.style.color = '';
                customerRequestsLabel.textContent = 'ê³ ê° ìš”ì²­ì‚¬í•­';
            }
        }

        /**
         * "ê³ ì •/ì„ íƒ" ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
         */
        function confirmSiteSelection() {
            const managerSelected = document.getElementById('manager').value;
            const siteSelected = document.getElementById('site_name').value;
            const reportSheetSelected = document.getElementById('reportSheetName').value;
            const responseDiv = document.getElementById('response');
            
            // ëª¨ë“  ë“œë¡­ë‹¤ìš´ì´ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (!managerSelected || !siteSelected || !reportSheetSelected) {
                responseDiv.textContent = 'ë§¤ë‹ˆì €, ë‹´ë‹¹ ì‚¬ì´íŠ¸, ë³´ê³ ì„œ ì‹œíŠ¸ ì´ë¦„ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.';
                responseDiv.style.display = 'block';
                responseDiv.style.backgroundColor = '#ffebee';
                responseDiv.style.color = '#c62828';
                return;
            }
            
            // ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸ ì¶”ê°€
            console.log('Selected site:', siteSelected);
            console.log('Sites without customer requests:', sitesWithoutCustomerRequests);
            console.log('Is site in exception list?', sitesWithoutCustomerRequests.includes(siteSelected));
            
            // ì‚¬ì´íŠ¸ ì„ íƒì— ë”°ë¼ ê³ ê° ìš”ì²­ì‚¬í•­ í•„ë“œ ìƒíƒœ ì„¤ì •
            toggleCustomerRequestsField(siteSelected);
            
            // Google Sheets ë§í¬ ìƒì„± (ì„ íƒëœ ë³´ê³ ì„œ ì‹œíŠ¸ì— ë”°ë¼)
            const selectedReportSheetName = document.getElementById('reportSheetName').value;
            const selectedOption = document.getElementById('reportSheetName').selectedOptions[0];
            const reportSheetId = selectedOption ? selectedOption.dataset.sheetId : '';
            const sheetUrl = `https://docs.google.com/spreadsheets/d/1Xrz9RlDXu3v6pBbuQc-B306gtXnG5CfebRG6KP44Kxs/edit#gid=${reportSheetId}`;
            
            // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
            responseDiv.innerHTML = `
                ì‚¬ì´íŠ¸ ì„ íƒì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤: ${siteSelected}<br>
                <a href="${sheetUrl}" target="_blank" style="color: #1976d2; text-decoration: underline; margin-top: 10px; display: inline-block;">
                    ğŸ“Š Google Sheetsì—ì„œ í™•ì¸í•˜ê¸°
                </a>
            `;
            responseDiv.style.display = 'block';
            responseDiv.style.backgroundColor = '#e8f5e8';
            responseDiv.style.color = '#2e7d32';
        }

        /**
         * ë³´ê³ ì„œ ì‹œíŠ¸ ì´ë¦„ ë“œë¡­ë‹¤ìš´ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         * @param {Array<{title: string, id: number}>} sheetNamesList í‘œì‹œí•  ì‹œíŠ¸ ì´ë¦„ ë° ID ëª©ë¡
         * @param {string} searchTerm ì‹œíŠ¸ ì´ë¦„ ê²€ìƒ‰ì–´ (í˜„ì¬ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
         */
        function updateReportSheetNameDropdown(sheetNamesList, searchTerm = '') {
            console.log('Updating Report Sheet Name Dropdown with:', sheetNamesList); // ì‹œíŠ¸ ì´ë¦„ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ ì „ ëª©ë¡ ì¶œë ¥
            const reportSheetNameSelect = document.getElementById('reportSheetName');
            reportSheetNameSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>'; // ê¸°ì¡´ ì˜µì…˜ ì œê±°

            // ê²€ìƒ‰ ê¸°ëŠ¥ì´ ì—†ìœ¼ë¯€ë¡œ ëª¨ë“  ì‹œíŠ¸ ì´ë¦„ í‘œì‹œ
            sheetNamesList.forEach(sheet => {
                const option = document.createElement('option');
                option.value = sheet.title;
                option.textContent = sheet.title;
                option.dataset.sheetId = sheet.id; // sheetIdë¥¼ data-sheet-id ì†ì„±ìœ¼ë¡œ ì €ì¥
                reportSheetNameSelect.appendChild(option);
            });
        }

        // ë§¤ë‹ˆì € ê²€ìƒ‰ í•„ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('searchManager').addEventListener('keyup', function() {
            const searchTerm = this.value.toLowerCase();
            const filteredManagers = originalManagers.filter(manager =>
                manager.toLowerCase().includes(searchTerm)
            );
            console.log('Filtered Managers (searchManager keyup):', filteredManagers); // ë§¤ë‹ˆì € ê²€ìƒ‰ í•„í„°ë§ ê²°ê³¼ ì¶œë ¥
            updateManagerDropdown(filteredManagers);
            updateReadReportButtonState(); // ë§¤ë‹ˆì € ë³€ê²½ ì‹œ ë³´ê³ ì„œ ì¡°íšŒ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        });

        // ì‚¬ì´íŠ¸ ê²€ìƒ‰ í•„ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('searchSite').addEventListener('keyup', function() {
            const searchTerm = this.value.toLowerCase();
            updateSiteDropdown(originalSites, searchTerm); // ë§¤ë‹ˆì € í•„í„°ë§ ì—†ì´ ì „ì²´ ì‚¬ì´íŠ¸ì—ì„œ ê²€ìƒ‰
            updateReadReportButtonState(); // ì‚¬ì´íŠ¸ ë³€ê²½ ì‹œ ë³´ê³ ì„œ ì¡°íšŒ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        });

        // ë§¤ë‹ˆì € ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì‹œ ë³´ê³ ì„œ ì¡°íšŒ ë²„íŠ¼ ë° ê³ ì •/ì„ íƒ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        document.getElementById('manager').addEventListener('change', function() {
            updateReadReportButtonState();
            updateConfirmSiteButtonState();
        });

        // ì‚¬ì´íŠ¸ ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì‹œ ë³´ê³ ì„œ ì¡°íšŒ ë²„íŠ¼ ìƒíƒœë§Œ ì—…ë°ì´íŠ¸
        document.getElementById('site_name').addEventListener('change', function() {
            updateReadReportButtonState();
            updateConfirmSiteButtonState();
        });

        // ë³´ê³ ì„œ ì‹œíŠ¸ ì´ë¦„ ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì‹œ ë³´ê³ ì„œ ì¡°íšŒ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        document.getElementById('reportSheetName').addEventListener('change', function() {
            updateReadReportButtonState();
            updateConfirmSiteButtonState();
        });

        // "ê³ ì •/ì„ íƒ" ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('confirmSiteButton').addEventListener('click', confirmSiteSelection);

        // "ë³´ê³ ì„œ ì¡°íšŒ" ë²„íŠ¼ì˜ í™œì„±í™”/ë¹„í™œì„±í™” ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
        function updateReadReportButtonState() {
            const managerSelected = document.getElementById('manager').value !== '';
            const siteSelected = document.getElementById('site_name').value !== '';
            const reportSheetNameSelected = document.getElementById('reportSheetName').value !== '';
            const readReportButton = document.getElementById('readReportButton');

            if (managerSelected && siteSelected && reportSheetNameSelected) {
                readReportButton.disabled = false;
                readReportButton.style.backgroundColor = '#4CAF50'; // ì›ë˜ ìƒ‰ìƒ
            } else {
                readReportButton.disabled = true;
                readReportButton.style.backgroundColor = '#cccccc'; // ë¹„í™œì„±í™” ìƒ‰ìƒ
            }
        }

        document.getElementById('reportForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            if (!gapi.client.getToken()) {
                // í† í°ì´ ì—†ìœ¼ë©´ ìŠ¹ì¸ ìš”ì²­
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) {
                        throw (resp);
                    }
                    // í† í° íšë“ í›„ í¼ ì œì¶œ ì¬ì‹œë„
                    submitFormData(event); // event ê°ì²´ ì „ë‹¬
                };
                tokenClient.requestAccessToken();
            } else {
                // í† í°ì´ ìˆìœ¼ë©´ ë°”ë¡œ í¼ ì œì¶œ
                submitFormData(event); // event ê°ì²´ ì „ë‹¬
            }
        });

        async function submitFormData(event) {
            const formData = {
                site_name: document.getElementById('site_name').value,
                manager: document.getElementById('manager').value,
                this_week_tasks: document.getElementById('this_week_tasks').value,
                next_week_tasks: document.getElementById('next_week_tasks').value,
                customer_requests: document.getElementById('customer_requests').value
            };

            console.log('Form Data:', formData);

            const responseDiv = document.getElementById('response');
            responseDiv.style.display = 'block';
            responseDiv.textContent = 'ë³´ê³ ì„œ ì œì¶œ ì¤‘...';

            // ë³´ê³ ì„œ ì‹œíŠ¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const SPREADSHEET_ID = '1Xrz9RlDXu3v6pBbuQc-B306gtXnG5CfebRG6KP44Kxs'; // ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID
            const REPORT_SHEET_NAME = document.getElementById('reportSheetName').value;
            const selectedOption = document.getElementById('reportSheetName').selectedOptions[0];
            const REPORT_SHEET_ID = selectedOption ? parseInt(selectedOption.dataset.sheetId) : null;
            
            // ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸ ì¶”ê°€
            console.log('Submit Form Data - Debug Info:');
            console.log('SPREADSHEET_ID:', SPREADSHEET_ID);
            console.log('REPORT_SHEET_NAME:', REPORT_SHEET_NAME);
            console.log('selectedOption:', selectedOption);
            console.log('REPORT_SHEET_ID:', REPORT_SHEET_ID);
            console.log('selectedOption.dataset.sheetId:', selectedOption ? selectedOption.dataset.sheetId : 'N/A');
            
            // ì‹œíŠ¸ IDê°€ ì—†ìœ¼ë©´ ì˜¤ë¥˜ ì²˜ë¦¬
            if (!REPORT_SHEET_ID) {
                console.error('REPORT_SHEET_ID is null or undefined');
                responseDiv.textContent = 'ë³´ê³ ì„œ ì‹œíŠ¸ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                return;
            }

            // ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì˜ ì—´ ìˆœì„œë¥¼ ì •ì˜í•©ë‹ˆë‹¤. SITEëª…, ë‹´ë‹¹ì, ê¸ˆì£¼ í•œ ì¼ ìˆœì„œì…ë‹ˆë‹¤.
            // ì‹¤ì œ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì˜ ì—´ ìˆœì„œì™€ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
            const COLUMN_ORDER = ['SITEëª…', 'ë‹´ë‹¹ì', 'ê¸ˆì£¼ í•œ ì¼']; 

            try {
                // ì‹œíŠ¸ì˜ ì „ì²´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `${REPORT_SHEET_NAME}!A:Z`, // ì¶©ë¶„íˆ ë„“ì€ ë²”ìœ„ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤ã€‚
                });

                const sheetData = response.result.values || [];

                // site_name ìœ„ì¹˜ ì°¾ê¸°
                const { row, col } = findCellCoordinates(sheetData, formData.site_name, REPORT_SHEET_NAME, COLUMN_ORDER);

                if (row === -1 || col === -1) {
                    throw new Error(`ë‹´ë‹¹ ì‚¬ì´íŠ¸ '${formData.site_name}'ë¥¼ ì‹œíŠ¸ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                }

                const updates = []; // values.batchUpdateë¥¼ ìœ„í•œ ì—…ë°ì´íŠ¸ ë°°ì—´

                // ëª¨ë“  ì…€ì— ì ìš©í•  ê³µí†µ ì„œì‹
                // const cellFormat = {
                //     textFormat: {
                //         fontSize: 11,
                //         bold: true,
                //         fontFamily: 'Arial' // í°íŠ¸ ë³€ì§ˆ ë°©ì§€ë¥¼ ìœ„í•´ Arial í°íŠ¸ ì§€ì •
                //     }
                // };

                // ë‹´ë‹¹ì ì…€ (site_name ì…€ì˜ í–‰ì€ ë™ì¼, ì—´ì€ ë°”ë¡œ ì˜¤ë¥¸ìª½)
                const managerColOffset = COLUMN_ORDER.indexOf('ë‹´ë‹¹ì');
                const managerRange = `'${REPORT_SHEET_NAME}'!${columnToLetter(col + managerColOffset)}${row + 1}`;
                updates.push({
                    range: managerRange,
                    values: [[formData.manager]]
                });

                // ê¸ˆì£¼ í•œ ì¼ ì…€ (site_name ì…€ì˜ í–‰ì€ ë™ì¼, ì—´ì€ 'ê¸ˆì£¼ í•œ ì¼'ì´ ìˆëŠ” ì—´)
                let thisWeekTasksRelativeOffset = COLUMN_ORDER.indexOf('ê¸ˆì£¼ í•œ ì¼');
                thisWeekTasksRelativeOffset += 1; // Nì—´ì—ì„œ Oì—´ë¡œ ì´ë™í•˜ê¸° ìœ„í•´ 1 ì¶”ê°€
                const thisWeekTasksRange = `'${REPORT_SHEET_NAME}'!${columnToLetter(col + thisWeekTasksRelativeOffset)}${row + 1}`;
                updates.push({
                    range: thisWeekTasksRange,
                    values: [[`â–¶ ${formData.this_week_tasks}`]]
                });

                // ì°¨ì£¼ í•  ì¼ ì…€ (site_name ì…€ì˜ í–‰ì€ ì•„ë˜ë¡œ 1ì¹¸, ì—´ì€ 'ê¸ˆì£¼ í•œ ì¼'ê³¼ ë™ì¼)
                const nextWeekTasksRange = `'${REPORT_SHEET_NAME}'!${columnToLetter(col + thisWeekTasksRelativeOffset)}${row + 2}`;
                updates.push({
                    range: nextWeekTasksRange,
                    values: [[`â–¶ ${formData.next_week_tasks}`]]
                });

                // ê³ ê° ìš”ì²­ì‚¬í•­ ì…€ (site_name ì…€ì˜ í–‰ì€ ì•„ë˜ë¡œ 2ì¹¸, ì—´ì€ 'ê¸ˆì£¼ í•œ ì¼'ê³¼ ë™ì¼)
                // ì˜ˆì™¸ ì‚¬ì´íŠ¸ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ê³ ê° ìš”ì²­ì‚¬í•­ ì²˜ë¦¬
                if (formData.customer_requests && !sitesWithoutCustomerRequests.includes(formData.site_name)) {
                    const customerRequestsRange = `'${REPORT_SHEET_NAME}'!${columnToLetter(col + thisWeekTasksRelativeOffset)}${row + 3}`;
                    updates.push({
                        range: customerRequestsRange,
                        values: [[`â–¶ ${formData.customer_requests}`]]
                    });
                }

                // batchUpdate ìš”ì²­ (ì…€ ê°’ë§Œ ì—…ë°ì´íŠ¸, ì„œì‹ ìœ ì§€)
                await gapi.client.sheets.spreadsheets.values.batchUpdate({
                    spreadsheetId: SPREADSHEET_ID,
                    resource: {
                        data: updates,
                        valueInputOption: 'USER_ENTERED'
                    }
                });

                // Google Sheets ë§í¬ ìƒì„±
                const sheetUrl = `https://docs.google.com/spreadsheets/d/1Xrz9RlDXu3v6pBbuQc-B306gtXnG5CfebRG6KP44Kxs/edit#gid=${REPORT_SHEET_ID}`;
                responseDiv.innerHTML = `
                    ë³´ê³ ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!<br>
                    <a href="${sheetUrl}" target="_blank" style="color: #1976d2; text-decoration: underline; margin-top: 10px; display: inline-block;">
                        ğŸ“Š Google Sheetsì—ì„œ í™•ì¸í•˜ê¸°
                    </a>
                `;

                // ë“œë¡­ë‹¤ìš´ ê°’ í™•ì¸ (ì´ˆê¸°í™”ë˜ê¸° ì „)
                console.log('Manager dropdown value before clearing text fields:', document.getElementById('manager').value);
                console.log('Site dropdown value before clearing text fields:', document.getElementById('site_name').value);
                console.log('Report Sheet Name dropdown value before clearing text fields:', document.getElementById('reportSheetName').value);

                // í…ìŠ¤íŠ¸ í•„ë“œë§Œ ì´ˆê¸°í™”
                document.getElementById('this_week_tasks').value = '';
                document.getElementById('next_week_tasks').value = '';
                document.getElementById('customer_requests').value = '';

            } catch (err) {
                console.error('Error submitting report:', err);
                responseDiv.textContent = 'ë³´ê³ ì„œ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (err.result?.error?.message || err.message);
            }
        }

        async function readReportData() {
            console.log('readReportData function called.');
            const readReportButton = document.getElementById('readReportButton');
            const responseDiv = document.getElementById('response');

            // ë²„íŠ¼ ìƒíƒœë¥¼ ë¡œë”© ì¤‘ìœ¼ë¡œ ë³€ê²½
            readReportButton.textContent = 'ë¡œë”© ì¤‘...';
            readReportButton.style.backgroundColor = '#ffc107'; // ë¡œë”© ì¤‘ ìƒ‰ìƒ (ì˜ˆ: ì£¼í™©ìƒ‰)
            readReportButton.disabled = true;
            responseDiv.style.display = 'block';
            responseDiv.textContent = 'ë³´ê³ ì„œ ë°ì´í„° ì¡°íšŒ ì¤‘...';

            const SPREADSHEET_ID = '1Xrz9RlDXu3v6pBbuQc-B306gtXnG5CfebRG6KP44Kxs';
            const selectedManager = document.getElementById('manager').value;
            const selectedSiteName = document.getElementById('site_name').value;
            const selectedReportSheetName = document.getElementById('reportSheetName').value;

            if (!selectedManager || !selectedSiteName || !selectedReportSheetName) {
                responseDiv.textContent = 'ë§¤ë‹ˆì €, ë‹´ë‹¹ ì‚¬ì´íŠ¸, ë³´ê³ ì„œ ì‹œíŠ¸ ì´ë¦„ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.';
                readReportButton.textContent = 'ë³´ê³ ì„œ ì¡°íšŒ';
                readReportButton.style.backgroundColor = '#4CAF50';
                readReportButton.disabled = false;
                return;
            }

            // ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì˜ ì—´ ìˆœì„œë¥¼ ì •ì˜í•©ë‹ˆë‹¤. (ë°ì´í„° ì“°ê¸°ì™€ ë™ì¼)
            const COLUMN_ORDER = ['SITEëª…', 'ë‹´ë‹¹ì', 'ê¸ˆì£¼ í•œ ì¼'];

            try {
                // ì‹œíŠ¸ì˜ ì „ì²´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (site_name ìœ„ì¹˜ ì°¾ê¸° ìœ„í•¨)
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `${selectedReportSheetName}!A:Z`,
                });
                const sheetData = response.result.values || [];

                // site_name ìœ„ì¹˜ ì°¾ê¸°
                const { row, col } = findCellCoordinates(sheetData, selectedSiteName, selectedReportSheetName, COLUMN_ORDER);

                if (row === -1 || col === -1) {
                    throw new Error(`ë‹´ë‹¹ ì‚¬ì´íŠ¸ '${selectedSiteName}'ë¥¼ ì‹œíŠ¸ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                }

                // ì½ì–´ì˜¬ ì…€ ë²”ìœ„ ê³„ì‚° (ì“°ê¸° ìœ„ì¹˜ì™€ ë™ì¼í•˜ê²Œ)
                let thisWeekTasksRelativeOffset = COLUMN_ORDER.indexOf('ê¸ˆì£¼ í•œ ì¼');
                thisWeekTasksRelativeOffset += 1; // Oì—´ë¡œ ì´ë™í•˜ê¸° ìœ„í•´ 1 ì¶”ê°€

                // ì˜ˆì™¸ ì‚¬ì´íŠ¸ì— ë”°ë¼ ì½ì–´ì˜¬ ë²”ìœ„ ê²°ì •
                const rangesToRead = [
                    `'${selectedReportSheetName}'!${columnToLetter(col + thisWeekTasksRelativeOffset)}${row + 1}`, // ê¸ˆì£¼ í•œ ì¼
                    `'${selectedReportSheetName}'!${columnToLetter(col + thisWeekTasksRelativeOffset)}${row + 2}`  // ì°¨ì£¼ í•  ì¼
                ];
                
                // ì˜ˆì™¸ ì‚¬ì´íŠ¸ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ê³ ê° ìš”ì²­ì‚¬í•­ ë²”ìœ„ ì¶”ê°€
                if (!sitesWithoutCustomerRequests.includes(selectedSiteName)) {
                    rangesToRead.push(`'${selectedReportSheetName}'!${columnToLetter(col + thisWeekTasksRelativeOffset)}${row + 3}`); // ê³ ê° ìš”ì²­ì‚¬í•­
                }

                console.log('Reading data from ranges:', rangesToRead);

                const readResponse = await gapi.client.sheets.spreadsheets.values.batchGet({
                    spreadsheetId: SPREADSHEET_ID,
                    ranges: rangesToRead,
                });
                console.log('Read API Response:', readResponse);

                const values = readResponse.result.valueRanges || [];

                // í…ìŠ¤íŠ¸ í•„ë“œì— ë°ì´í„° ì¶œë ¥
                document.getElementById('this_week_tasks').value = (values[0] && values[0].values && values[0].values[0]) ? values[0].values[0][0].replace(/^â–¶\s*/, '') : '';
                document.getElementById('next_week_tasks').value = (values[1] && values[1].values && values[1].values[0]) ? values[1].values[0][0].replace(/^â–¶\s*/, '') : '';
                
                // ì˜ˆì™¸ ì‚¬ì´íŠ¸ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ê³ ê° ìš”ì²­ì‚¬í•­ ì½ê¸°
                if (!sitesWithoutCustomerRequests.includes(selectedSiteName)) {
                    // ì˜ˆì™¸ ì‚¬ì´íŠ¸ê°€ ì•„ë‹Œ ê²½ìš° values[2]ê°€ ê³ ê° ìš”ì²­ì‚¬í•­
                    document.getElementById('customer_requests').value = (values[2] && values[2].values && values[2].values[0]) ? values[2].values[0][0].replace(/^â–¶\s*/, '') : '';
                } else {
                    document.getElementById('customer_requests').value = ''; // ì˜ˆì™¸ ì‚¬ì´íŠ¸ëŠ” ë¹ˆ ê°’ìœ¼ë¡œ ì„¤ì •
                }

                // Google Sheets ë§í¬ ìƒì„± (ì„ íƒëœ ë³´ê³ ì„œ ì‹œíŠ¸ì— ë”°ë¼)
                const selectedOption = document.getElementById('reportSheetName').selectedOptions[0];
                const reportSheetId = selectedOption ? selectedOption.dataset.sheetId : '';
                const sheetUrl = `https://docs.google.com/spreadsheets/d/1Xrz9RlDXu3v6pBbuQc-B306gtXnG5CfebRG6KP44Kxs/edit#gid=${reportSheetId}`;
                responseDiv.innerHTML = `
                    ë³´ê³ ì„œ ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ì¡°íšŒí–ˆìŠµë‹ˆë‹¤!<br>
                    <a href="${sheetUrl}" target="_blank" style="color: #1976d2; text-decoration: underline; margin-top: 10px; display: inline-block;">
                        ğŸ“Š Google Sheetsì—ì„œ í™•ì¸í•˜ê¸°
                    </a>
                `;
                readReportButton.textContent = 'ì¡°íšŒ ì™„ë£Œ';
                readReportButton.style.backgroundColor = '#6c757d';
                // ì¡°íšŒ ì™„ë£Œ í›„ì—ë„ ë‹¤ì‹œ ì¡°íšŒí•  ìˆ˜ ìˆë„ë¡ í™œì„±í™” ìƒíƒœ ìœ ì§€
                readReportButton.disabled = false; 

                // 3ì´ˆ ë’¤ ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
                setTimeout(() => {
                    readReportButton.textContent = 'ë³´ê³ ì„œ ì¡°íšŒ';
                    readReportButton.style.backgroundColor = '#4CAF50'; // ì›ë˜ ìƒ‰ìƒ
                    readReportButton.disabled = false;
                }, 3000); // 3ì´ˆ (3000ms)

            } catch (err) {
                console.error('Error reading report data:', err);
                responseDiv.textContent = 'ë³´ê³ ì„œ ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (err.result?.error?.message || err.message || JSON.stringify(err));
                readReportButton.textContent = 'ë³´ê³ ì„œ ì¡°íšŒ';
                readReportButton.style.backgroundColor = '#dc3545'; // ì˜¤ë¥˜ ì‹œ ë¹¨ê°„ìƒ‰
                readReportButton.disabled = false;
            }
        }

        document.getElementById('queryDropdownsButton').addEventListener('click', populateDropdowns);

        // ë³´ê³ ì„œ ì¡°íšŒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('readReportButton').addEventListener('click', readReportData);

        // ì‚¬ìš©ë²• íŒì—… ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const helpButton = document.getElementById('helpButton');
        const helpModal = document.getElementById('helpModal');
        const closeButton = document.querySelector('.close');

        helpButton.addEventListener('click', function() {
            helpModal.style.display = 'block';
        });

        closeButton.addEventListener('click', function() {
            helpModal.style.display = 'none';
        });

        // ë°°ê²½ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
        window.addEventListener('click', function(event) {
            if (event.target === helpModal) {
                helpModal.style.display = 'none';
            }
        });

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && helpModal.style.display === 'block') {
                helpModal.style.display = 'none';
            }
        });

        /**
         * ì‹œíŠ¸ ë°ì´í„°ì—ì„œ íŠ¹ì • site_nameì„ ì°¾ì•„ í•´ë‹¹ ì…€ì˜ 0-based í–‰ê³¼ ì—´ ì¸ë±ìŠ¤ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
         * site_nameì€ 'SITEëª…' ì—´(Bì—´, Gì—´, Lì—´ ë“±)ì— ìœ„ì¹˜í•œë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.
         * @param {Array<Array<string>>} sheetData ì‹œíŠ¸ì˜ ì „ì²´ 2ì°¨ì› ë°°ì—´ ë°ì´í„°
         * @param {string} siteName ì°¾ì„ site_name
         * @param {string} sheetName í˜„ì¬ ì‹œíŠ¸ ì´ë¦„
         * @param {Array<string>} columnOrder ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì˜ ì—´ ìˆœì„œ (ì˜ˆ: ['SITEëª…', 'ë‹´ë‹¹ì', 'ê¸ˆì£¼ í•œ ì¼'])
         * @returns {{row: number, col: number}} site_nameì´ ë°œê²¬ëœ 0-based í–‰ ë° ì—´ ì¸ë±ìŠ¤. ì°¾ì§€ ëª»í•˜ë©´ {row: -1, col: -1}.
         */
        function findCellCoordinates(sheetData, siteName, sheetName, columnOrder) {
            const siteNameColIndexInOrder = columnOrder.indexOf('SITEëª…');
            
            for (let r = 0; r < sheetData.length; r++) {
                const row = sheetData[r];
                for (let c = 0; c < row.length; c++) {
                    // SITEëª… ì—´ì— í•´ë‹¹í•˜ëŠ” ê²½ìš°ì—ë§Œ ê²€ìƒ‰
                    // ì—¬ê¸°ì„œëŠ” columnOrderì˜ 'SITEëª…'ì´ ì‹¤ì œ Sheetsì˜ ì–´ëŠ ì—´ì— í•´ë‹¹í•˜ëŠ”ì§€ë¥¼ ì•Œì•„ì•¼ í•©ë‹ˆë‹¤.
                    // ê°„ë‹¨í™”ë¥¼ ìœ„í•´, ì‹¤ì œ Sheetsì—ì„œ SITEëª…ì´ íŠ¹ì • ì—´ì— ê·œì¹™ì ìœ¼ë¡œ ë‚˜íƒ€ë‚œë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.
                    // ì˜ˆë¥¼ ë“¤ì–´, B, G, L ì—´ì— SITEëª…ì´ ìˆë‹¤ë©´, c % 5 === 1 (0-based) ê³¼ ê°™ì€ ê·œì¹™ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    // í˜„ì¬ëŠ” ëª¨ë“  ì…€ì„ ê²€ìƒ‰í•©ë‹ˆë‹¤. ë³´ë‹¤ ì •í™•í•œ ë¡œì§ì´ í•„ìš”í•˜ë©´ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
                    if (row[c] === siteName) {
                         // ì—¬ê¸°ì„œ `c`ëŠ” site_nameì´ ë°œê²¬ëœ ì‹¤ì œ 0-based ì—´ ì¸ë±ìŠ¤ì…ë‹ˆë‹¤ã€‚
                         // ì´ `c`ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë‹¤ë¥¸ ì»¬ëŸ¼ì˜ ì˜¤í”„ì…‹ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
                        return { row: r, col: c };
                    }
                }
            }
            return { row: -1, col: -1 };
        }

        /**
         * 0-based ì—´ ì¸ë±ìŠ¤ë¥¼ A1 í‘œê¸°ë²•ì˜ ì—´ ë¬¸ì(ì˜ˆ: 0 -> A, 25 -> Z, 26 -> AA)ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
         * @param {number} colIndex 0-based ì—´ ì¸ë±ìŠ¤
         * @returns {string} A1 í‘œê¸°ë²• ì—´ ë¬¸ì
         */
        function columnToLetter(colIndex) {
            let temp, letter = '';
            while (colIndex >= 0) {
                temp = colIndex % 26;
                letter = String.fromCharCode(temp + 65) + letter;
                colIndex = Math.floor(colIndex / 26) - 1;
            }
            return letter;
        }
    </script>

    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
