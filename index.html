<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주간 업무 보고</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 600px; margin: auto; }
        h1 { text-align: center; color: #333; }
        .form-group { margin-bottom: 15px; }
        
        /* 그룹 박스 스타일 */
        .form-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .form-section h3 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
            font-weight: 600;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 8px;
        }
        
        .form-section .form-group {
            margin-bottom: 12px;
        }
        
        .form-section .form-group:last-child {
            margin-bottom: 0;
        }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        
        /* 섹션 제목과 체크박스 스타일 */
        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }
        
        .section-header label {
            margin: 0;
            flex: 1;
        }
        
        .section-header .none-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #666;
        }
        
        .section-header .none-checkbox input[type="checkbox"] {
            margin: 0;
            width: auto;
        }
        
        .section-header .none-checkbox label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }
        
        /* 비활성화된 섹션 스타일 */
        .section-disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        /* 비활성화된 체크박스와 버튼 스타일 */
        .section-disabled .none-checkbox input[type="checkbox"] {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .section-disabled .none-checkbox label {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .section-disabled .add-item-btn {
            opacity: 0.5;
            pointer-events: none;
        }
        
        /* 제출 버튼 중앙 정렬 */
        .submit-button-container {
            text-align: center;
            margin-top: 20px;
        }
        
        .submit-button-container button {
            margin: 0 auto;
        }

        /* 라벨과 체크박스를 같은 라인에 배치 */
        .label-with-checkbox {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .simple-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .simple-checkbox label {
            font-weight: normal;
            margin: 0;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* 복사/붙여넣기 버튼 스타일 */
        .copy-btn, .paste-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 5px;
            transition: background-color 0.2s ease;
            white-space: nowrap;
        }
        
        .copy-btn:hover, .paste-btn:hover {
            background-color: #5a6268;
        }
        
        .copy-btn:active, .paste-btn:active {
            background-color: #495057;
        }
        
        .copy-btn.copied {
            background-color: #28a745;
        }
        
        .paste-btn.pasted {
            background-color: #17a2b8;
        }
        
        .target-checkboxes {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .copy-paste-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .date-label {
            font-size: 12px;
            color: #666;
            margin-right: 5px;
        }
        
        
        input[type="text"], textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea { resize: vertical; min-height: 100px; }
        
        /* 리스트 입력 스타일 */
        .list-input-container {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background-color: #f9f9f9;
        }
        
        .list-input-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .list-input-item:last-child {
            margin-bottom: 0;
        }
        
        .list-input-item input {
            flex: 1;
            margin-right: 8px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            /* 모바일에서 줄바꿈 방지 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* 고객 요청사항 전용 스타일 */
        .list-input-item.customer-request-item {
            display: block;
            position: relative;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            /* 파일 문서처럼 왼쪽 위 모서리 튀어나온 효과 */
            border-top-left-radius: 0;
        }
        
        .list-input-item.customer-request-item::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            width: 20px;
            height: 20px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom-right-radius: 8px;
            border-top-left-radius: 4px;
        }
        
        .list-input-item.customer-request-item .date-label {
            display: inline-block;
            margin-bottom: 4px;
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }
        
        .list-input-item.customer-request-item .date-input {
            width: 120px;
            margin-bottom: 8px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            background-color: #f8f9fa;
            display: block;
        }
        
        .list-input-item.customer-request-item .date-input:focus {
            outline: none;
            border-color: #4CAF50;
            background-color: white;
        }
        
        .list-input-item.customer-request-item .list-input {
            width: 100%;
            margin-right: 0;
            margin-bottom: 8px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background-color: #fafafa;
            white-space: normal;
            overflow: visible;
            text-overflow: unset;
            resize: vertical;
            min-height: 40px;
        }
        
        .list-input-item.customer-request-item .list-input:focus {
            outline: none;
            border-color: #4CAF50;
            background-color: white;
        }
        
        .list-input-item.customer-request-item .remove-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .list-input-item.customer-request-item .remove-btn:hover {
            background-color: #c82333;
        }
        
        /* 작업 대상 선택 스타일 */
        .list-input-item .target-label {
            display: inline-block;
            margin-bottom: 4px;
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }
        
        .list-input-item .target-checkboxes {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        
        .list-input-item .target-checkbox-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .list-input-item .target-checkbox-item input[type="checkbox"] {
            margin: 0;
            width: auto;
        }
        
        .list-input-item .target-checkbox-item label {
            margin: 0;
            font-size: 12px;
            font-weight: normal;
            cursor: pointer;
        }
        
        .list-input-item .remove-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .list-input-item .remove-btn:hover {
            background-color: #c82333;
        }
        
        .add-item-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            margin-top: 8px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .add-item-btn:hover {
            background-color: #5a6268;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .add-item-btn:active {
            transform: translateY(0);
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover { background-color: #45a049; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        .response { margin-top: 20px; padding: 10px; background-color: #e2e2e2; border-radius: 4px; }
        
        /* 헤더 섹션 스타일 */
        .header-section {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }
        
        .header-section h1 {
            margin: 0;
        }
        
        .help-button {
            position: absolute;
            right: 0;
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .help-button:hover {
            background-color: #1976D2;
        }
        
        /* 버튼 그룹 스타일 */
        .button-group {
            display: flex;
            gap: 10px;
        }
        
        .button-group button {
            flex: 1;
        }
        
        /* 매니저/사이트 조회 버튼 중앙정렬 */
        .query-button-container {
            text-align: center;
            margin: 15px 0;
        }
        
        .query-button-container button {
            margin: 0 auto;
        }
        
        /* 모달 스타일 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #ddd;
            background-color: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #333;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .step {
            display: flex;
            margin-bottom: 20px;
            align-items: flex-start;
        }
        
        .step-number {
            font-size: 24px;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .step-content {
            flex: 1;
            line-height: 1.6;
        }
        
        .step-content strong {
            color: #2196F3;
            font-size: 16px;
        }
        
        .account-info {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            border-left: 4px solid #2196F3;
        }
        
        .account-info h3 {
            margin: 0 0 10px 0;
            color: #1976D2;
        }
        
        .account-info p {
            margin: 5px 0;
            font-family: monospace;
            background-color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
        }
        
        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .header-section {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            
            .help-button {
                position: static;
                margin-top: 10px;
            }
            
            .modal-content {
                width: 95%;
                margin: 5% auto;
                max-height: 90vh;
            }
            
            .modal-header {
                padding: 15px;
            }
            
            .modal-header h2 {
                font-size: 18px;
            }
            
            .modal-body {
                padding: 15px;
            }
            
            .step {
                flex-direction: column;
                text-align: center;
                margin-bottom: 15px;
            }
            
            .step-number {
                margin-right: 0;
                margin-bottom: 8px;
                font-size: 20px;
            }
            
            .step-content {
                font-size: 14px;
            }
            
            .step-content strong {
                font-size: 14px;
            }
            
            .account-info {
                padding: 12px;
                margin-top: 15px;
            }
            
            .account-info h3 {
                font-size: 16px;
            }
            
            .account-info p {
                font-size: 13px;
                padding: 4px 8px;
            }
        }
        
        /* 매우 작은 화면 (320px 이하) */
        @media (max-width: 480px) {
            .modal-content {
                width: 98%;
                margin: 2% auto;
                max-height: 95vh;
            }
            
            .modal-header {
                padding: 12px;
            }
            
            .modal-header h2 {
                font-size: 16px;
            }
            
            .modal-body {
                padding: 12px;
            }
            
            .step {
                margin-bottom: 12px;
            }
            
            .step-number {
                font-size: 18px;
            }
            
            .step-content {
                font-size: 13px;
            }
            
            .account-info {
                padding: 10px;
            }
        }
    </style>

    <script>
        // 환경변수 주입
        window.ENV_SPREADSHEET_ID = '1fmWVqEOJavKVMGT6IZguBMg1kG8bnPdiO_x_FhuXJ-s';
        console.log('Environment variables injected:', {
            SPREADSHEET_ID: '1fmWVqEOJavKVMGT6IZguBMg1kG8bnPdiO_x_FhuXJ-s'
        });
    </script>


    <script>
        // 환경변수 주입
        window.ENV_SPREADSHEET_ID = '1Xrz9RlDXu3v6pBbuQc-B306gtXnG5CfebRG6KP44Kxs';
        console.log('Environment variables injected:', {
            SPREADSHEET_ID: '1Xrz9RlDXu3v6pBbuQc-B306gtXnG5CfebRG6KP44Kxs'
        });
    </script>

</head>
<body>
    <div class="container">
        <div class="header-section">
            <h1>주간 업무 보고 입력</h1>
            <button id="helpButton" class="help-button">📖 사용법</button>
        </div>
        <form id="reportForm">
            <!-- 선택 섹션 -->
            <div class="form-section">
                <h3>📋 기본 정보 선택</h3>
                <div class="form-group">
                    <label for="manager">매니저 이름:</label>
                    <select id="manager" name="manager" required>
                        <option value="">선택하세요</option>
                    </select>
                    <input type="text" id="managerDirectInput" placeholder="매니저 이름을 입력하세요 (예: 홍길동,이춘향 또는 홍길동 이춘향)" style="display: none; margin-top: 5px;">
                </div>
                <div class="form-group">
                    <div class="label-with-checkbox">
                        <label for="site_name">담당 사이트:</label>
                        <div class="simple-checkbox">
                            <input type="checkbox" id="showMySitesOnly" checked>
                            <label for="showMySitesOnly">내 담당 사이트만</label>
                        </div>
                    </div>
                    <select id="site_name" name="site_name" required>
                        <option value="">선택하세요</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reportSheetName">보고서 시트 이름:</label>
                    <select id="reportSheetName" name="reportSheetName" required>
                        <option value="">선택하세요</option>
                    </select>
                    <div id="weeklySheetInfo" style="margin-top: 8px; padding: 8px; background-color: #e3f2fd; border: 1px solid #2196f3; border-radius: 4px; font-size: 14px; color: #1976d2; display: none;">
                        <strong>📅 이번 주 작성 시트: </strong><span id="currentWeekSheet"></span>
                    </div>
                </div>
                <div class="form-group query-button-container">
                    <button type="button" id="queryDropdownsButton" disabled>매니저/사이트 목록 조회</button>
                </div>
                <div class="form-group button-group">
                    <button type="button" id="readReportButton" disabled>보고서 조회</button>
                    <button type="button" id="readLastWeekReportButton" disabled>지난 주 보고서 조회</button>
                </div>
            </div>
                        <!-- 입력 섹션 -->
            <div class="form-section">
                <h3>📝 보고서 작성</h3>
                <div class="form-group">
                    <div class="section-header">
                        <label for="this_week_tasks">금주 한 일:</label>
                        <div class="none-checkbox">
                            <input type="checkbox" id="this_week_none" onchange="toggleSection('this_week_tasks_container', this.checked)">
                            <label for="this_week_none">없음</label>
                        </div>
                    </div>
                    <div class="list-input-container" id="this_week_tasks_container">
                        <div class="list-input-item customer-request-item">
                            <div class="target-label">(작업 대상)</div>
                            <div class="target-checkboxes">
                                <div class="target-checkbox-item">
                                    <input type="checkbox" id="this_week_dev_1" name="this_week_target_1" value="개발계">
                                    <label for="this_week_dev_1">개발계</label>
                                </div>
                                <div class="target-checkbox-item">
                                    <input type="checkbox" id="this_week_ops_1" name="this_week_target_1" value="운영계">
                                    <label for="this_week_ops_1">운영계</label>
                                </div>
                                <div class="target-checkbox-item">
                                    <input type="checkbox" id="this_week_etc_1" name="this_week_target_1" value="기타">
                                    <label for="this_week_etc_1">기타</label>
                                </div>
                                <div class="copy-paste-container">
                                    <button type="button" class="copy-btn" onclick="copyListData('this_week_tasks_container')" title="금주 한 일 복사">Copy</button>
                                    <button type="button" class="paste-btn" onclick="pasteListData('this_week_tasks_container')" title="금주 한 일 붙여넣기">Paste</button>
                                </div>
                            </div>
                            <textarea placeholder="금주 한 일을 입력하세요..." class="list-input" rows="3"></textarea>
                            <button type="button" class="remove-btn" onclick="removeListItem(this)">×</button>
                        </div>
                    </div>
                    <button type="button" class="add-item-btn" onclick="addListItem('this_week_tasks_container')">+ 항목 추가</button>
                </div>
                <div class="form-group">
                    <div class="section-header">
                        <label for="next_week_tasks">향후 할 일:</label>
                        <div class="none-checkbox">
                            <input type="checkbox" id="next_week_none" onchange="toggleSection('next_week_tasks_container', this.checked)">
                            <label for="next_week_none">없음</label>
                        </div>
                    </div>
                    <div class="list-input-container" id="next_week_tasks_container">
                        <div class="list-input-item customer-request-item">
                            <div class="target-label">(작업 대상)</div>
                            <div class="target-checkboxes">
                                <div class="target-checkbox-item">
                                    <input type="checkbox" id="next_week_dev_1" name="next_week_target_1" value="개발계">
                                    <label for="next_week_dev_1">개발계</label>
                                </div>
                                <div class="target-checkbox-item">
                                    <input type="checkbox" id="next_week_ops_1" name="next_week_target_1" value="운영계">
                                    <label for="next_week_ops_1">운영계</label>
                                </div>
                                <div class="target-checkbox-item">
                                    <input type="checkbox" id="next_week_etc_1" name="next_week_target_1" value="기타">
                                    <label for="next_week_etc_1">기타</label>
                                </div>
                                <div class="copy-paste-container">
                                    <button type="button" class="copy-btn" onclick="copyListData('next_week_tasks_container')" title="향후 할 일 복사">Copy</button>
                                    <button type="button" class="paste-btn" onclick="pasteListData('next_week_tasks_container')" title="향후 할 일 붙여넣기">Paste</button>
                                </div>
                            </div>
                            <textarea placeholder="향후 할 일을 입력하세요..." class="list-input" rows="3"></textarea>
                            <button type="button" class="remove-btn" onclick="removeListItem(this)">×</button>
                        </div>
                    </div>
                    <button type="button" class="add-item-btn" onclick="addListItem('next_week_tasks_container')">+ 항목 추가</button>
                </div>
                <div class="form-group">
                    <div class="section-header">
                        <label for="customer_requests">고객 요청사항:</label>
                        <div class="none-checkbox">
                            <input type="checkbox" id="customer_requests_none" onchange="toggleSection('customer_requests_container', this.checked)">
                            <label for="customer_requests_none">없음</label>
                        </div>
                    </div>
                    <div class="list-input-container" id="customer_requests_container">
                        <div class="list-input-item customer-request-item">
                            <div class="target-label">(발생일)</div>
                            <div class="target-checkboxes">
                                <div class="date-label">(발생일)</div>
                                <input type="date" class="date-input" title="발생일 선택">
                                <div class="copy-paste-container">
                                    <button type="button" class="copy-btn" onclick="copyListItemData(this)" title="이 항목 복사">Copy</button>
                                    <button type="button" class="paste-btn" onclick="pasteListItemData(this)" title="이 항목에 붙여넣기">Paste</button>
                                </div>
                            </div>
                            <textarea placeholder="고객 요청사항을 입력하세요..." class="list-input" rows="3"></textarea>
                            <button type="button" class="remove-btn" onclick="removeListItem(this)">×</button>
                        </div>
                    </div>
                    <button type="button" class="add-item-btn" onclick="addListItem('customer_requests_container')">+ 항목 추가</button>
                </div>
                <div class="form-group submit-button-container">
                    <button type="submit" disabled>보고서 제출</button>
                </div>
            </div>
        </form>
        <div id="response" class="response" style="display: none;"></div>
    </div>

    <!-- 제출 완료 모달 -->
    <div id="submitSuccessModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;">
                <h2>✅ 제출 완료</h2>
                <span class="close" onclick="closeSubmitSuccessModal()">&times;</span>
            </div>
            <div class="modal-body" style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 48px; margin-bottom: 20px;">🎉</div>
                <h3 style="color: #4CAF50; margin-bottom: 15px;">보고서가 성공적으로 제출되었습니다!</h3>
                <p style="color: #666; margin-bottom: 30px;">Google Sheets에 저장되었습니다.</p>
                <div id="submitSuccessSheetLink" style="margin-bottom: 30px;"></div>
                <button onclick="closeSubmitSuccessModal()" style="
                    background: #4CAF50;
                    color: white;
                    border: none;
                    padding: 12px 40px;
                    font-size: 16px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-weight: bold;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                    transition: all 0.3s ease;
                " onmouseover="this.style.background='#45a049'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)'" 
                   onmouseout="this.style.background='#4CAF50'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.2)'">
                    확인
                </button>
            </div>
        </div>
    </div>

    <!-- 사용법 팝업 모달 -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📖 사용법</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="step">
                    <div class="step-number">1️⃣</div>
                    <div class="step-content">
                        <strong>매니저/사이트 목록 조회</strong><br>
                        "매니저/사이트 목록 조회" 버튼을 클릭하여 데이터를 불러옵니다.
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-number">2️⃣</div>
                    <div class="step-content">
                        <strong>정보 선택</strong><br>
                        매니저 이름, 담당 사이트, 보고서 시트를 선택합니다.<br>
                        <em>💡 매니저가 2명 이상인 경우: "직접입력"을 선택하고 "홍길동,이춘향" 또는 "홍길동 이춘향" 형태로 입력하세요.</em>
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-number">3️⃣</div>
                    <div class="step-content">
                        <strong>보고서 제출</strong><br>
                        텍스트를 입력한 후 "보고서 제출" 버튼을 클릭합니다.<br>
                        <em>💡 사이트 선택 시 프로젝트 사이트인 경우 고객 요청사항이 자동으로 비활성화됩니다.</em>
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-number">4️⃣</div>
                    <div class="step-content">
                        <strong>수정 시</strong><br>
                        기존 데이터를 수정할 때는 "보고서 조회" 버튼으로 데이터를 불러온 후 수정하고 "보고서 제출" 버튼을 클릭합니다.
                    </div>
                </div>
                
                <div class="account-info">
                    <h3>🔐 Google 공용 계정</h3>
                    <p><strong>ID:</strong> interezen502@gmail.com</p>
                    <p><strong>PW:</strong> inter502</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Google API 설정
        const CLIENT_ID = '898247770764-ev4i2nonvqnd4n8evrnivt75i2t78s0u.apps.googleusercontent.com'; // Google Cloud Console에서 발급받은 클라이언트 ID를 입력하세요.
        const API_KEY = 'AIzaSyBV_qqUNlgCkRAt7sITJbzxt38I3gZ5Z-4';     // Google Cloud Console에서 발급받은 API 키를 입력하세요.
        const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
        const SCOPES = "https://www.googleapis.com/auth/spreadsheets";
        
        // 환경변수에서 스프레드시트 ID 가져오기 (기본값: 테스트 스프레드시트)
        const SPREADSHEET_ID = window.ENV_SPREADSHEET_ID || '1Xrz9RlDXu3v6pBbuQc-B306gtXnG5CfebRG6KP44Kxs';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // 원본 매니저 및 사이트 목록 (검색 필터링용)
        let originalManagers = [];
        let originalSites = [];
        // 원본 보고서 시트 이름 목록 (검색 필터링용)
        let originalReportSheetNames = [];
        
        // L40 이후 범위의 사이트들 (고객 요청사항 입력 불가) - 동적으로 생성됨
        let sitesWithoutCustomerRequests = [];
        
        // 매니저-사이트 매핑 데이터
        let managerSiteMapping = {};
        
        // 보고서 시트 필터링 관련 변수
        let showAllSheets = false;

        // 매니저-사이트 매핑 데이터 로드
        async function loadManagerSiteMapping() {
            try {
                const response = await fetch('./manager_site_mapping.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                managerSiteMapping = data.managerSiteMapping;
                console.log('Manager-Site mapping loaded successfully:', Object.keys(managerSiteMapping).length, 'managers');
            } catch (error) {
                console.error('Error loading manager-site mapping:', error);
                managerSiteMapping = {};
            }
        }

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: DISCOVERY_DOCS,
            });
            // Sheets API를 명시적으로 로드합니다.
            await gapi.client.load('sheets', 'v4');
            gapiInited = true;
            maybeEnableForm();
        }

        function gisLoaded() {
            console.log('🔧 GIS (Google Identity Services) 로드됨');
            console.log('🔧 CLIENT_ID:', CLIENT_ID);
            console.log('🔧 SCOPES:', SCOPES);
            console.log('🔧 현재 URL:', window.location.href);
            console.log('🔧 현재 Origin:', window.location.origin);
            
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (resp) => {
                    console.log('🔧 OAuth 콜백 응답:', resp);
                    if (resp.error !== undefined) {
                        console.error('❌ OAuth 오류:', resp.error);
                        console.error('❌ 오류 상세:', resp.error_description);
                        console.error('❌ 전체 응답:', resp);
                        throw (resp);
                    }
                    console.log('✅ OAuth 성공, 토큰 설정');
                    gapi.client.setToken(resp);
                },
            });
            gisInited = true; // 이 부분을 callback 밖으로 이동
            maybeEnableForm(); // 이 부분을 callback 밖으로 이동
        }

        function maybeEnableForm() {
            console.log('maybeEnableForm called.'); // maybeEnableForm 함수 호출 로그 추가
            console.log('gapiInited:', gapiInited, 'gisInited:', gisInited); // gapiInited, gisInited 상태 로그 추가
            if (gapiInited && gisInited) {
                // 폼을 활성화하고 드롭다운 데이터를 로드합니다.
                // populateDropdowns()는 이제 조회 버튼 클릭 시 호출됩니다.
                document.getElementById('queryDropdownsButton').disabled = false;
                document.querySelector('button[type="submit"]').disabled = false;
                console.log('Dropdowns and Submit buttons enabled.'); // 버튼 활성화 로그 추가
            } else {
                console.log('Dropdowns and Submit buttons NOT yet enabled (waiting for gapi/gis init).'); // 버튼 비활성화 상태 로그 추가
            }
        }



        async function populateDropdowns() {
            console.log('🔧 populateDropdowns 함수 시작');
            console.log('🔧 gapi.client 상태:', gapi.client);
            console.log('🔧 현재 토큰:', gapi.client.getToken());
            const managerSelect = document.getElementById('manager');
            const siteSelect = document.getElementById('site_name');
            const reportSheetNameSelect = document.getElementById('reportSheetName');
            const queryButton = document.getElementById('queryDropdownsButton');

            // 버튼 상태를 로딩 중으로 변경
            queryButton.textContent = '로딩 중...';
            queryButton.style.backgroundColor = '#ffc107'; // 로딩 중 색상 (예: 주황색)
            queryButton.disabled = true;

            // 기존 옵션 제거 (첫 번째 '선택하세요' 옵션 제외)
            managerSelect.innerHTML = '<option value="">선택하세요</option>';
            siteSelect.innerHTML = '<option value="">선택하세요</option>';
            reportSheetNameSelect.innerHTML = '<option value="">선택하세요</option>';

            // SPREADSHEET_ID는 상단에서 환경변수로 설정됨
            const DROPDOWN_SHEET_NAME = 'SITE 분장 현황'; // 드롭다운 데이터가 있는 시트 이름
            const MANAGER_RANGE = `${DROPDOWN_SHEET_NAME}!B4:B1000`; // B4부터 시작하여 매니저 이름만 가져오기
            const SITE_RANGE = `${DROPDOWN_SHEET_NAME}!A:Z`; // 사이트 데이터는 기존대로 전체 범위

            try {
                console.log('Requesting dropdown data from Google Sheets API...');
                console.log('Spreadsheet ID:', SPREADSHEET_ID);
                console.log('Manager Range:', MANAGER_RANGE);
                console.log('Site Range:', SITE_RANGE);

                // 매니저 이름 데이터 가져오기 (B4부터)
                const managerResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: MANAGER_RANGE,
                });

                // 사이트 데이터 가져오기 (기존 방식)
                const siteResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: SITE_RANGE,
                });

                console.log('Google Sheets API Response (Manager Data):', managerResponse); // API 응답 출력
                console.log('Google Sheets API Response (Site Data):', siteResponse); // API 응답 출력

                const managerData = managerResponse.result.values || [];
                const siteData = siteResponse.result.values || [];
                console.log('Extracted managerData:', managerData); // 추출된 매니저 데이터 출력
                console.log('Extracted siteData:', siteData); // 추출된 사이트 데이터 출력

                const managers = new Set();
                const sites = new Set();

                // 매니저 이름 처리 (B4부터 시작하므로 헤더 없이 바로 처리)
                for (let r = 0; r < managerData.length; r++) {
                    const managerCell = managerData[r] && managerData[r][0] ? managerData[r][0].trim() : '';
                    if (managerCell && managerCell !== '') {
                        managers.add(managerCell);
                    }
                }

                // 사이트 데이터 처리 (기존 방식 유지)
                for (let r = 0; r < siteData.length; r++) {
                    const rowData = siteData[r] || [];
                    // Sites start from Column E (index 4)
                    for (let c = 4; c < rowData.length; c++) {
                        const siteCell = rowData[c] ? rowData[c].trim() : '';
                        if (siteCell !== '') {
                            sites.add(siteCell);
                        }
                    }
                }

                originalManagers = Array.from(managers).sort();
                // originalSites = Array.from(sites).sort(); // SITE 분장 현황에서 사이트 가져오는 로직 주석 처리
                console.log('Original Managers:', originalManagers); // 원본 매니저 목록 출력
                // console.log('Original Sites:', originalSites);     // 원본 사이트 목록 출력 (임시 주석 처리)

                // 매니저 드롭다운 채우기
                updateManagerDropdown(originalManagers);

                // 스프레드시트 메타데이터 가져와서 YYYY-MM-DD 형식의 시트 이름 찾기
                console.log('Requesting spreadsheet metadata...');
                const spreadsheetMetadataResponse = await gapi.client.sheets.spreadsheets.get({
                    spreadsheetId: SPREADSHEET_ID,
                });
                console.log('Google Sheets API Response (Spreadsheet Metadata):', spreadsheetMetadataResponse);

                // YYYY-MM-DD 형식의 시트 이름 필터링
                const datePattern = /^\d{4}-\d{2}-\d{2}$/;
                originalReportSheetNames = spreadsheetMetadataResponse.result.sheets
                    .filter(sheet => datePattern.test(sheet.properties.title))
                    .map(sheet => ({
                        title: sheet.properties.title,
                        id: sheet.properties.sheetId  // sheetId 대신 id로 변경
                    }))
                    .sort((a, b) => b.title.localeCompare(a.title)); // 최신 날짜가 먼저 오도록 정렬

                // 보고서 시트 이름 가져오기 및 채우기
                console.log('Original Report Sheet Names with IDs:', originalReportSheetNames); // 원본 시트 이름 목록과 ID 출력
                showAllSheets = false; // 초기화 시에는 제한된 목록만 표시
                updateReportSheetNameDropdown(originalReportSheetNames);
                
                // 이번 주 작성 시트 정보 표시
                updateWeeklySheetInfo();

                // --- 이제 가장 최신 YYYY-MM-DD 시트에서 SITE명 가져오기 ---
                if (originalReportSheetNames.length > 0) {
                    const latestReportSheetName = originalReportSheetNames[0].title; // 가장 최신 시트 (정렬되어 있음)
                    console.log('Fetching site names from latest report sheet:', latestReportSheetName);

                    // 사용자 제공 패턴에 따른 SITE명 셀 범위 (전체 범위로 확장)
                    const siteNameRanges = [
                        `'${latestReportSheetName}'!B:B`, // B열 전체에서 SITE명 찾기
                        `'${latestReportSheetName}'!G:G`, // G열 전체에서 SITE명 찾기
                        `'${latestReportSheetName}'!L:L`, // L열 전체에서 SITE명 찾기
                    ];

                    try {
                        const siteResponse = await gapi.client.sheets.spreadsheets.values.batchGet({
                            spreadsheetId: SPREADSHEET_ID,
                            ranges: siteNameRanges,
                        });
                        console.log('Site Names Batch Get Response:', siteResponse);

                        const fetchedSites = new Set();
                        const lColumnSitesWithoutCustomerRequests = new Set(); // L열의 40행 이후 사이트들
                        
                        siteResponse.result.valueRanges.forEach((rangeData, rangeIndex) => {
                            if (rangeData.values) {
                                rangeData.values.forEach((row, rowIndex) => {
                                    if (row.length > 0 && row[0] && row[0].trim() !== '') {
                                        const cellValue = row[0].trim();
                                        // 헤더나 설명 텍스트가 아닌 실제 사이트명만 필터링
                                        if (cellValue !== 'SITE명' && 
                                            !cellValue.includes('금주 한 일') && 
                                            !cellValue.includes('차주 할 일') && 
                                            !cellValue.includes('고객 요청사항') &&
                                            !cellValue.includes('본인 성명') &&
                                            !cellValue.includes('필수 입력') &&
                                            !cellValue.includes('없음') &&
                                            !cellValue.includes('▶') &&
                                            !cellValue.includes('구분') &&
                                            !cellValue.includes('작성 등록일') &&
                                            !cellValue.includes('매주 목요일') &&
                                            !cellValue.includes('휴일은 전일') &&
                                            !cellValue.includes('각 항목') &&
                                            !cellValue.includes('작성 내용이 없으면') &&
                                            !cellValue.includes('SITE명 순서') &&
                                            !cellValue.includes('프로젝트 순 표시') &&
                                            !cellValue.includes('25년 현재') &&
                                            !cellValue.includes('추진 中 프로젝트') &&
                                            rowIndex >= 3) { // 4행부터 시작 (0-based이므로 3)
                                            
                                            fetchedSites.add(cellValue);
                                            
                                            // L열(rangeIndex === 2)이고 40행 이후(rowIndex >= 39, 0-based이므로 40행은 39)인 경우
                                            if (rangeIndex === 2 && rowIndex >= 39) {
                                                lColumnSitesWithoutCustomerRequests.add(cellValue);
                                                console.log(`L열 40행 이후 사이트 발견: ${cellValue} (행: ${rowIndex + 1})`);
                                            }
                                        }
                                    }
                                });
                            }
                        });
                        
                        // L열 40행 이후 사이트들을 예외 목록에 추가
                        sitesWithoutCustomerRequests = Array.from(lColumnSitesWithoutCustomerRequests);
                        console.log('동적으로 생성된 예외 사이트 목록:', sitesWithoutCustomerRequests);
                        originalSites = Array.from(fetchedSites).sort();
                        console.log('Original Sites from latest report sheet:', originalSites); // 새로 가져온 사이트 목록 출력

                    } catch (siteErr) {
                        console.error('Error fetching site names from latest report sheet:', siteErr);
                        // 오류 발생 시 사이트 목록을 비워둠
                        originalSites = [];
                    }
                } else {
                    console.log('No YYYY-MM-DD report sheets found, cannot fetch site names.');
                    originalSites = [];
                }

                // 사이트 드롭다운 채우기
                updateSiteDropdown(originalSites);
                
                // 초기 상태에서 고객 요청사항 필드 상태 설정
                toggleCustomerRequestsField('');

                // Google Sheets 링크 생성 (전체 스프레드시트)
                const mainSheetUrl = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/edit`;
                document.getElementById('response').innerHTML = `
                    매니저/사이트/시트 목록을 성공적으로 불러왔습니다.<br>
                    <a href="${mainSheetUrl}" target="_blank" style="color: #1976d2; text-decoration: underline; margin-top: 10px; display: inline-block;">
                        📊 Google Sheets에서 확인하기
                    </a>
                `;
                
                document.getElementById('response').style.display = 'block';

                // 드롭다운 조회 버튼 숨김 처리
                queryButton.style.display = 'none';

            } catch (err) {
                console.error('Error fetching dropdown data (detailed):', err); // 상세 오류 출력
                document.getElementById('response').textContent = '드롭다운 데이터를 불러오는 데 실패했습니다: ' + (err.result?.error?.message || err.message || JSON.stringify(err));
                document.getElementById('response').style.display = 'block';

                // 오류 발생 시에도 버튼 숨김 (재시도는 페이지 새로고침으로)
                const queryButton = document.getElementById('queryDropdownsButton');
                queryButton.style.display = 'none';
            }
        }

        /**
         * 매니저 드롭다운을 업데이트합니다.
         * @param {Array<string>} managersList 표시할 매니저 목록
         */
        function updateManagerDropdown(managersList) {
            console.log('Updating Manager Dropdown with:', managersList); // 매니저 드롭다운 업데이트 전 목록 출력
            const managerSelect = document.getElementById('manager');
            managerSelect.innerHTML = '<option value="">선택하세요</option>'; // 기존 옵션 제거
            
            // 직접입력 옵션을 맨 위에 추가
            const directInputOption = document.createElement('option');
            directInputOption.value = '직접입력';
            directInputOption.textContent = '직접입력';
            managerSelect.appendChild(directInputOption);
            
            // 매니저 목록 추가
            managersList.forEach(manager => {
                const option = document.createElement('option');
                option.value = manager;
                option.textContent = manager;
                managerSelect.appendChild(option);
            });
        }

        /**
         * 사이트 드롭다운을 업데이트합니다.
         * @param {Array<string>} sitesList 표시할 사이트 목록
         */
        function updateSiteDropdown(sitesList) {
            console.log('Updating Site Dropdown with:', sitesList); // 사이트 드롭다운 업데이트 전 목록 출력
            const siteSelect = document.getElementById('site_name');
            siteSelect.innerHTML = '<option value="">선택하세요</option>'; // 기존 옵션 제거

            let filteredSites = sitesList;

            // "내 담당 사이트만 보기" 체크박스가 체크된 경우 필터링
            const showMySitesOnly = document.getElementById('showMySitesOnly').checked;
            
            if (showMySitesOnly) {
                const selectedManager = getManagerValue();
                if (selectedManager && managerSiteMapping[selectedManager]) {
                    const managerSites = managerSiteMapping[selectedManager];
                    filteredSites = filteredSites.filter(site => 
                        managerSites.includes(site)
                    );
                    console.log('Filtered to manager sites only:', filteredSites.length, 'sites for', selectedManager);
                } else {
                    console.log('No manager selected or no mapping found, showing all sites');
                }
            }

            filteredSites.sort();

            filteredSites.forEach(site => {
                const option = document.createElement('option');
                option.value = site;
                
                // 고객 요청사항 입력 불가 사이트인 경우 "(프로젝트)" 접두사 추가
                if (sitesWithoutCustomerRequests.includes(site)) {
                    option.textContent = `(프로젝트) ${site}`;
                } else {
                    option.textContent = site;
                }
                
                siteSelect.appendChild(option);
            });
        }


        /**
         * 선택된 매니저 값을 가져옵니다 (드롭다운 또는 직접입력).
         * @returns {string} 매니저 이름 (여러 명인 경우 줄바꿈으로 구분)
         */
        function getManagerValue() {
            const managerSelect = document.getElementById('manager');
            const directInput = document.getElementById('managerDirectInput');
            
            if (managerSelect.value === '직접입력') {
                const inputValue = directInput.value.trim();
                if (inputValue === '') return '';
                
                // 콤마나 공백으로 구분된 이름들을 줄바꿈으로 변환
                return inputValue.split(/[,\s]+/).filter(name => name.trim() !== '').join('\n');
            } else {
                return managerSelect.value;
            }
        }


        /**
         * 선택된 사이트에 따라 고객 요청사항 필드를 활성화/비활성화합니다.
         * @param {string} selectedSite 선택된 사이트명
         */
        function toggleCustomerRequestsField(selectedSite) {
            const customerRequestsContainer = document.getElementById('customer_requests_container');
            const customerRequestsLabel = document.querySelector('label[for="customer_requests"]');
            const noneCheckbox = document.getElementById('customer_requests_none');
            const addItemBtn = customerRequestsContainer.parentElement.querySelector('.add-item-btn');
            
            console.log('toggleCustomerRequestsField called with:', selectedSite);
            console.log('Checking if site is in exception list...');
            
            if (sitesWithoutCustomerRequests.includes(selectedSite)) {
                // 고객 요청사항 입력 불가 사이트인 경우
                customerRequestsContainer.style.opacity = '0.5';
                customerRequestsContainer.style.pointerEvents = 'none';
                customerRequestsContainer.style.backgroundColor = '#f5f5f5';
                customerRequestsLabel.style.color = '#999';
                customerRequestsLabel.textContent = '고객 요청사항 (입력 불가)';
                
                // "없음" 체크박스 비활성화
                if (noneCheckbox) {
                    noneCheckbox.disabled = true;
                    noneCheckbox.checked = false;
                }
                
                // "항목 추가" 버튼 비활성화
                if (addItemBtn) {
                    addItemBtn.disabled = true;
                }
                
                // 기존 값 초기화
                setListData('customer_requests_container', '');
            } else {
                // 일반 사이트인 경우
                customerRequestsContainer.style.opacity = '1';
                customerRequestsContainer.style.pointerEvents = 'auto';
                customerRequestsContainer.style.backgroundColor = '';
                customerRequestsLabel.style.color = '';
                customerRequestsLabel.textContent = '고객 요청사항';
                
                // "없음" 체크박스 활성화
                if (noneCheckbox) {
                    noneCheckbox.disabled = false;
                }
                
                // "항목 추가" 버튼 활성화
                if (addItemBtn) {
                    addItemBtn.disabled = false;
                }
            }
        }


        /**
         * 보고서 시트 이름 드롭다운을 업데이트합니다.
         * @param {Array<{title: string, id: number}>} sheetNamesList 표시할 시트 이름 및 ID 목록
         */
        function updateReportSheetNameDropdown(sheetNamesList) {
            console.log('Updating Report Sheet Name Dropdown with:', sheetNamesList); // 시트 이름 드롭다운 업데이트 전 목록 출력
            const reportSheetNameSelect = document.getElementById('reportSheetName');
            reportSheetNameSelect.innerHTML = '<option value="">선택하세요</option>'; // 기존 옵션 제거

            let filteredSheets = sheetNamesList;
            
            // showAllSheets가 false인 경우 이번 주 작성 시트 기준으로 과거 3주치만 표시
            if (!showAllSheets) {
                const thisWeekSheetName = getThisWeekSheetName();
                filteredSheets = filterSheetsByWeek(sheetNamesList, thisWeekSheetName);
            }

            // 필터링된 시트 이름 표시
            filteredSheets.forEach(sheet => {
                const option = document.createElement('option');
                option.value = sheet.title;
                option.textContent = sheet.title;
                option.dataset.sheetId = sheet.id; // sheetId를 data-sheet-id 속성으로 저장
                reportSheetNameSelect.appendChild(option);
            });

            // 전체 시트가 필터링된 결과보다 많고 showAllSheets가 false인 경우 "(더보기)" 옵션 추가
            if (!showAllSheets && sheetNamesList.length > filteredSheets.length) {
                const moreOption = document.createElement('option');
                moreOption.value = 'more';
                moreOption.textContent = '(더보기)';
                moreOption.style.fontStyle = 'italic';
                moreOption.style.color = '#666';
                reportSheetNameSelect.appendChild(moreOption);
            }
        }

        /**
         * 이번 주 작성 시트 이름을 계산합니다.
         * @returns {string} 이번 주 작성 시트 이름 (YYYY-MM-DD 형식)
         */
        function getThisWeekSheetName() {
            const today = new Date();
            const currentDay = today.getDay(); // 0=일요일, 1=월요일, ..., 4=목요일, ..., 6=토요일
            
            // 목요일까지의 일수 계산 (목요일이 4)
            let daysToThursday = 4 - currentDay;
            if (daysToThursday < 0) {
                daysToThursday += 7; // 다음 주 목요일
            }
            
            // 이번 주 목요일 날짜 계산
            const thisWeekThursday = new Date(today);
            thisWeekThursday.setDate(today.getDate() + daysToThursday);
            
            // YYYY-MM-DD 형식으로 포맷
            const year = thisWeekThursday.getFullYear();
            const month = String(thisWeekThursday.getMonth() + 1).padStart(2, '0');
            const day = String(thisWeekThursday.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * 이번 주 작성 시트 기준으로 과거 3주치 시트만 필터링합니다.
         * @param {Array<{title: string, id: number}>} sheetNamesList 전체 시트 목록
         * @param {string} thisWeekSheetName 이번 주 작성 시트 이름
         * @returns {Array<{title: string, id: number}>} 필터링된 시트 목록
         */
        function filterSheetsByWeek(sheetNamesList, thisWeekSheetName) {
            const thisWeekDate = new Date(thisWeekSheetName);
            const threeWeeksAgo = new Date(thisWeekDate);
            threeWeeksAgo.setDate(thisWeekDate.getDate() - 21); // 3주 = 21일 전
            
            return sheetNamesList.filter(sheet => {
                const sheetDate = new Date(sheet.title);
                // 이번 주 시트부터 3주 전까지의 시트만 포함
                return sheetDate >= threeWeeksAgo && sheetDate <= thisWeekDate;
            });
        }

        /**
         * 이번 주 작성 시트를 계산하고 표시합니다.
         * 목요일 기준으로 이번 주 시트를 계산합니다.
         */
        function updateWeeklySheetInfo() {
            const thisWeekSheetName = getThisWeekSheetName();
            
            // UI에 표시
            const weeklySheetInfo = document.getElementById('weeklySheetInfo');
            const currentWeekSheet = document.getElementById('currentWeekSheet');
            
            if (weeklySheetInfo && currentWeekSheet) {
                currentWeekSheet.textContent = thisWeekSheetName;
                weeklySheetInfo.style.display = 'block';
                
                // 해당 시트가 드롭다운에 있는지 확인하고 강조 표시
                const reportSheetSelect = document.getElementById('reportSheetName');
                const options = reportSheetSelect.querySelectorAll('option');
                let found = false;
                
                options.forEach(option => {
                    if (option.value === thisWeekSheetName) {
                        option.style.backgroundColor = '#e3f2fd';
                        option.style.fontWeight = 'bold';
                        found = true;
                    }
                });
                
                if (!found) {
                    // 시트가 없으면 경고 표시
                    weeklySheetInfo.style.backgroundColor = '#fff3cd';
                    weeklySheetInfo.style.borderColor = '#ffc107';
                    weeklySheetInfo.style.color = '#856404';
                    currentWeekSheet.innerHTML = `${thisWeekSheetName} <span style="color: #dc3545;">(시트 없음)</span>`;
                } else {
                    // 시트가 있으면 정상 표시
                    weeklySheetInfo.style.backgroundColor = '#e3f2fd';
                    weeklySheetInfo.style.borderColor = '#2196f3';
                    weeklySheetInfo.style.color = '#1976d2';
                    currentWeekSheet.textContent = thisWeekSheetName;
                }
            }
        }


        // 매니저 드롭다운 변경 시 보고서 조회 버튼 상태 업데이트
        document.getElementById('manager').addEventListener('change', function() {
            const directInput = document.getElementById('managerDirectInput');
            if (this.value === '직접입력') {
                directInput.style.display = 'block';
                directInput.focus();
            } else {
                directInput.style.display = 'none';
                directInput.value = '';
            }
            updateReadReportButtonState();
            updateLastWeekReportButtonState();
            
            // 매니저 변경 시 사이트 드롭다운 업데이트 (체크박스 상태 반영)
            updateSiteDropdown(originalSites);
        });

        // 직접입력 필드 변경 시 버튼 상태 업데이트
        document.getElementById('managerDirectInput').addEventListener('input', function() {
            updateReadReportButtonState();
            updateLastWeekReportButtonState();
            
            // 직접입력 변경 시 사이트 드롭다운 업데이트 (체크박스 상태 반영)
            updateSiteDropdown(originalSites);
        });

        // 사이트 드롭다운 변경 시 보고서 조회 버튼 상태 업데이트 및 고객 요청사항 필드 자동 활성화/비활성화
        document.getElementById('site_name').addEventListener('change', function() {
            const selectedSite = this.value;
            
            // 사이트 선택 시 자동으로 고객 요청사항 필드 활성화/비활성화
            if (selectedSite) {
                toggleCustomerRequestsField(selectedSite);
            }
            
            updateReadReportButtonState();
            updateLastWeekReportButtonState();
        });

        // "내 담당 사이트만 보기" 체크박스 변경 시 사이트 드롭다운 업데이트
        document.getElementById('showMySitesOnly').addEventListener('change', function() {
            updateSiteDropdown(originalSites);
        });

        // 보고서 시트 이름 드롭다운 변경 시 보고서 조회 버튼 상태 업데이트
        document.getElementById('reportSheetName').addEventListener('change', function() {
            // "(더보기)" 옵션이 선택된 경우 전체 시트 표시
            if (this.value === 'more') {
                showAllSheets = true;
                updateReportSheetNameDropdown(originalReportSheetNames);
                this.value = ''; // 선택 초기화
                return;
            }
            
            updateReadReportButtonState();
            updateLastWeekReportButtonState();
        });


        // "보고서 조회" 버튼의 활성화/비활성화 상태를 업데이트하는 헬퍼 함수
        function updateReadReportButtonState() {
            const managerValue = getManagerValue();
            const siteSelected = document.getElementById('site_name').value !== '';
            const reportSheetNameSelected = document.getElementById('reportSheetName').value !== '';
            const readReportButton = document.getElementById('readReportButton');

            if (managerValue !== '' && siteSelected && reportSheetNameSelected) {
                readReportButton.disabled = false;
                readReportButton.style.backgroundColor = '#4CAF50'; // 원래 색상
            } else {
                readReportButton.disabled = true;
                readReportButton.style.backgroundColor = '#cccccc'; // 비활성화 색상
            }
        }

        // "지난 주 보고서 조회" 버튼의 활성화/비활성화 상태를 업데이트하는 헬퍼 함수
        function updateLastWeekReportButtonState() {
            const managerValue = getManagerValue();
            const siteSelected = document.getElementById('site_name').value !== '';
            const reportSheetNameSelected = document.getElementById('reportSheetName').value !== '';
            const lastWeekReportButton = document.getElementById('readLastWeekReportButton');

            if (managerValue !== '' && siteSelected && reportSheetNameSelected) {
                lastWeekReportButton.disabled = false;
                lastWeekReportButton.style.backgroundColor = '#9C27B0'; // 보라색 (지난 주 보고서 조회)
            } else {
                lastWeekReportButton.disabled = true;
                lastWeekReportButton.style.backgroundColor = '#cccccc'; // 비활성화 색상
            }
        }

        // 1주일 이전 날짜를 계산하는 함수 (YYYY-MM-DD 형식)
        function getLastWeekDate(currentDateStr) {
            try {
                // 현재 날짜 문자열을 Date 객체로 변환
                const currentDate = new Date(currentDateStr);
                
                // 1주일(7일) 이전 날짜 계산
                const lastWeekDate = new Date(currentDate);
                lastWeekDate.setDate(currentDate.getDate() - 7);
                
                // YYYY-MM-DD 형식으로 반환
                const year = lastWeekDate.getFullYear();
                const month = String(lastWeekDate.getMonth() + 1).padStart(2, '0');
                const day = String(lastWeekDate.getDate()).padStart(2, '0');
                
                return `${year}-${month}-${day}`;
            } catch (error) {
                console.error('날짜 계산 오류:', error);
                return null;
            }
        }

        document.getElementById('reportForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            // 엔터키로 제출되는 것을 방지 (버튼 클릭으로만 제출)
            if (event.submitter === null) {
                console.log('Form submission blocked - only button clicks allowed');
                return;
            }

            if (!gapi.client.getToken()) {
                // 토큰이 없으면 승인 요청
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) {
                        throw (resp);
                    }
                    // 토큰 획득 후 폼 제출 재시도
                    submitFormData(event); // event 객체 전달
                };
                tokenClient.requestAccessToken();
            } else {
                // 토큰이 있으면 바로 폼 제출
                submitFormData(event); // event 객체 전달
            }
        });

        async function submitFormData(event) {
            const formData = {
                site_name: document.getElementById('site_name').value,
                manager: getManagerValue(), // 직접입력 또는 드롭다운 선택 값
                this_week_tasks: getListData('this_week_tasks_container'),
                next_week_tasks: getListData('next_week_tasks_container'),
                customer_requests: getListData('customer_requests_container')
            };

            console.log('Form Data:', formData);
            console.log('Sites without customer requests:', sitesWithoutCustomerRequests);
            console.log('Is current site in exception list?', sitesWithoutCustomerRequests.includes(formData.site_name));

            const responseDiv = document.getElementById('response');
            responseDiv.style.display = 'block';
            responseDiv.textContent = '보고서 제출 중...';

            // 보고서 시트 정보 가져오기
            // SPREADSHEET_ID는 상단에서 환경변수로 설정됨
            const REPORT_SHEET_NAME = document.getElementById('reportSheetName').value;
            const selectedOption = document.getElementById('reportSheetName').selectedOptions[0];
            const REPORT_SHEET_ID = selectedOption ? parseInt(selectedOption.dataset.sheetId) : null;
            
            // 디버깅을 위한 로그 추가
            console.log('Submit Form Data - Debug Info:');
            console.log('SPREADSHEET_ID:', SPREADSHEET_ID);
            console.log('REPORT_SHEET_NAME:', REPORT_SHEET_NAME);
            console.log('selectedOption:', selectedOption);
            console.log('REPORT_SHEET_ID:', REPORT_SHEET_ID);
            console.log('selectedOption.dataset.sheetId:', selectedOption ? selectedOption.dataset.sheetId : 'N/A');
            
            // 시트 ID가 없으면 오류 처리
            if (!REPORT_SHEET_ID) {
                console.error('REPORT_SHEET_ID is null or undefined');
                responseDiv.textContent = '보고서 시트 ID를 찾을 수 없습니다. 다시 시도해주세요.';
                return;
            }

            // 스프레드시트의 열 순서를 정의합니다. SITE명, 담당자, 금주 한 일 순서입니다.
            // 실제 스프레드시트의 열 순서와 일치해야 합니다.
            const COLUMN_ORDER = ['SITE명', '담당자', '금주 한 일']; 

            try {
                // 시트의 전체 데이터 가져오기
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `${REPORT_SHEET_NAME}!A:Z`, // 충분히 넓은 범위로 데이터를 가져옵니다。
                });

                const sheetData = response.result.values || [];

                // site_name 위치 찾기
                const { row, col } = findCellCoordinates(sheetData, formData.site_name, REPORT_SHEET_NAME, COLUMN_ORDER);

                if (row === -1 || col === -1) {
                    throw new Error(`담당 사이트 '${formData.site_name}'를 시트에서 찾을 수 없습니다.`);
                }

                const updates = []; // values.batchUpdate를 위한 업데이트 배열

                // 모든 셀에 적용할 공통 서식
                // const cellFormat = {
                //     textFormat: {
                //         fontSize: 11,
                //         bold: true,
                //         fontFamily: 'Arial' // 폰트 변질 방지를 위해 Arial 폰트 지정
                //     }
                // };

                // 담당자 셀 (site_name 셀의 행은 동일, 열은 바로 오른쪽)
                const managerColOffset = COLUMN_ORDER.indexOf('담당자');
                const managerRange = `'${REPORT_SHEET_NAME}'!${columnToLetter(col + managerColOffset)}${row + 1}`;
                updates.push({
                    range: managerRange,
                    values: [[formData.manager]]
                });

                // 금주 한 일 셀 (site_name 셀의 행은 동일, 열은 '금주 한 일'이 있는 열)
                let thisWeekTasksRelativeOffset = COLUMN_ORDER.indexOf('금주 한 일');
                thisWeekTasksRelativeOffset += 1; // N열에서 O열로 이동하기 위해 1 추가
                const thisWeekTasksRange = `'${REPORT_SHEET_NAME}'!${columnToLetter(col + thisWeekTasksRelativeOffset)}${row + 1}`;
                updates.push({
                    range: thisWeekTasksRange,
                    values: [[`▶ ${formData.this_week_tasks}`]]
                });

                // 차주 할 일 셀 (site_name 셀의 행은 아래로 1칸, 열은 '금주 한 일'과 동일)
                const nextWeekTasksRange = `'${REPORT_SHEET_NAME}'!${columnToLetter(col + thisWeekTasksRelativeOffset)}${row + 2}`;
                updates.push({
                    range: nextWeekTasksRange,
                    values: [[`▶ ${formData.next_week_tasks}`]]
                });

                // 고객 요청사항 셀 (site_name 셀의 행은 아래로 2칸, 열은 '금주 한 일'과 동일)
                // 예외 사이트가 아닌 경우에만 고객 요청사항 처리
                if (formData.customer_requests && !sitesWithoutCustomerRequests.includes(formData.site_name)) {
                    const customerRequestsRange = `'${REPORT_SHEET_NAME}'!${columnToLetter(col + thisWeekTasksRelativeOffset)}${row + 3}`;
                    updates.push({
                        range: customerRequestsRange,
                        values: [[`▶ ${formData.customer_requests}`]]
                    });
                }

                // batchUpdate 요청 (셀 값만 업데이트, 서식 유지)
                await gapi.client.sheets.spreadsheets.values.batchUpdate({
                    spreadsheetId: SPREADSHEET_ID,
                    resource: {
                        data: updates,
                        valueInputOption: 'USER_ENTERED'
                    }
                });

                // Google Sheets 링크 생성
                const sheetUrl = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/edit#gid=${REPORT_SHEET_ID}`;
                
                // 제출 완료 모달 표시
                showSubmitSuccessModal(sheetUrl);
                
                // 기존 응답 영역 숨김
                responseDiv.style.display = 'none';

                // 드롭다운 값 확인
                console.log('Manager dropdown value:', document.getElementById('manager').value);
                console.log('Site dropdown value:', document.getElementById('site_name').value);
                console.log('Report Sheet Name dropdown value:', document.getElementById('reportSheetName').value);

                // 제출 후에도 입력 내용 유지 (초기화하지 않음)

            } catch (err) {
                console.error('Error submitting report:', err);
                responseDiv.textContent = '보고서 제출 중 오류가 발생했습니다: ' + (err.result?.error?.message || err.message);
            }
        }

        async function readReportData() {
            console.log('readReportData function called.');
            const readReportButton = document.getElementById('readReportButton');
            const responseDiv = document.getElementById('response');

            // 버튼 상태를 로딩 중으로 변경
            readReportButton.textContent = '로딩 중...';
            readReportButton.style.backgroundColor = '#ffc107'; // 로딩 중 색상 (예: 주황색)
            readReportButton.disabled = true;
            responseDiv.style.display = 'block';
            responseDiv.textContent = '보고서 데이터 조회 중...';

            // SPREADSHEET_ID는 상단에서 환경변수로 설정됨
            const managerValue = getManagerValue();
            const selectedSiteName = document.getElementById('site_name').value;
            const selectedReportSheetName = document.getElementById('reportSheetName').value;

            if (!managerValue || !selectedSiteName || !selectedReportSheetName) {
                responseDiv.textContent = '매니저, 담당 사이트, 보고서 시트 이름을 모두 선택해주세요.';
                readReportButton.textContent = '보고서 조회';
                readReportButton.style.backgroundColor = '#4CAF50';
                readReportButton.disabled = false;
                return;
            }

            // 스프레드시트의 열 순서를 정의합니다. (데이터 쓰기와 동일)
            const COLUMN_ORDER = ['SITE명', '담당자', '금주 한 일'];

            try {
                // 시트의 전체 데이터 가져오기 (site_name 위치 찾기 위함)
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `${selectedReportSheetName}!A:Z`,
                });
                const sheetData = response.result.values || [];

                // site_name 위치 찾기
                const { row, col } = findCellCoordinates(sheetData, selectedSiteName, selectedReportSheetName, COLUMN_ORDER);

                if (row === -1 || col === -1) {
                    throw new Error(`담당 사이트 '${selectedSiteName}'를 시트에서 찾을 수 없습니다.`);
                }

                // 읽어올 셀 범위 계산 (쓰기 위치와 동일하게)
                let thisWeekTasksRelativeOffset = COLUMN_ORDER.indexOf('금주 한 일');
                thisWeekTasksRelativeOffset += 1; // O열로 이동하기 위해 1 추가

                // 예외 사이트에 따라 읽어올 범위 결정
                const rangesToRead = [
                    `'${selectedReportSheetName}'!${columnToLetter(col + thisWeekTasksRelativeOffset)}${row + 1}`, // 금주 한 일
                    `'${selectedReportSheetName}'!${columnToLetter(col + thisWeekTasksRelativeOffset)}${row + 2}`  // 차주 할 일
                ];
                
                // 예외 사이트가 아닌 경우에만 고객 요청사항 범위 추가
                if (!sitesWithoutCustomerRequests.includes(selectedSiteName)) {
                    rangesToRead.push(`'${selectedReportSheetName}'!${columnToLetter(col + thisWeekTasksRelativeOffset)}${row + 3}`); // 고객 요청사항
                }

                console.log('Reading data from ranges:', rangesToRead);

                const readResponse = await gapi.client.sheets.spreadsheets.values.batchGet({
                    spreadsheetId: SPREADSHEET_ID,
                    ranges: rangesToRead,
                });
                console.log('Read API Response:', readResponse);

                const values = readResponse.result.valueRanges || [];

                // 리스트 필드에 데이터 출력 (▶는 setListData에서 자동 제거됨)
                const thisWeekTasks = (values[0] && values[0].values && values[0].values[0]) ? values[0].values[0][0] : '';
                const nextWeekTasks = (values[1] && values[1].values && values[1].values[0]) ? values[1].values[0][0] : '';
                setListData('this_week_tasks_container', thisWeekTasks);
                setListData('next_week_tasks_container', nextWeekTasks);
                
                // 예외 사이트가 아닌 경우에만 고객 요청사항 읽기
                if (!sitesWithoutCustomerRequests.includes(selectedSiteName)) {
                    // 예외 사이트가 아닌 경우 values[2]가 고객 요청사항
                    const customerRequests = (values[2] && values[2].values && values[2].values[0]) ? values[2].values[0][0] : '';
                    setListData('customer_requests_container', customerRequests);
                } else {
                    setListData('customer_requests_container', ''); // 예외 사이트는 빈 값으로 설정
                }

                // Google Sheets 링크 생성 (선택된 보고서 시트에 따라)
                const selectedOption = document.getElementById('reportSheetName').selectedOptions[0];
                const reportSheetId = selectedOption ? selectedOption.dataset.sheetId : '';
                const sheetUrl = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/edit#gid=${reportSheetId}`;
                responseDiv.innerHTML = `
                    보고서 데이터를 성공적으로 조회했습니다!<br>
                    <a href="${sheetUrl}" target="_blank" style="color: #1976d2; text-decoration: underline; margin-top: 10px; display: inline-block;">
                        📊 Google Sheets에서 확인하기
                    </a>
                `;
                readReportButton.textContent = '조회 완료';
                readReportButton.style.backgroundColor = '#6c757d';
                // 조회 완료 후에도 다시 조회할 수 있도록 활성화 상태 유지
                readReportButton.disabled = false; 

                // 3초 뒤 버튼 상태 초기화
                setTimeout(() => {
                    readReportButton.textContent = '보고서 조회';
                    readReportButton.style.backgroundColor = '#4CAF50'; // 원래 색상
                    readReportButton.disabled = false;
                }, 3000); // 3초 (3000ms)

            } catch (err) {
                console.error('Error reading report data:', err);
                responseDiv.textContent = '보고서 데이터 조회 중 오류가 발생했습니다: ' + (err.result?.error?.message || err.message || JSON.stringify(err));
                readReportButton.textContent = '보고서 조회';
                readReportButton.style.backgroundColor = '#dc3545'; // 오류 시 빨간색
                readReportButton.disabled = false;
            }
        }

        document.getElementById('queryDropdownsButton').addEventListener('click', populateDropdowns);

        // 지난 주 보고서 조회 함수
        async function readLastWeekReportData() {
            console.log('readLastWeekReportData function called.');
            const lastWeekReportButton = document.getElementById('readLastWeekReportButton');
            const responseDiv = document.getElementById('response');

            // 버튼 상태를 로딩 중으로 변경
            lastWeekReportButton.textContent = '로딩 중...';
            lastWeekReportButton.style.backgroundColor = '#ffc107'; // 로딩 중 색상 (예: 주황색)
            lastWeekReportButton.disabled = true;
            responseDiv.style.display = 'block';
            responseDiv.textContent = '지난 주 보고서 데이터 조회 중...';

            // SPREADSHEET_ID는 상단에서 환경변수로 설정됨
            const managerValue = getManagerValue();
            const selectedSiteName = document.getElementById('site_name').value;
            const selectedReportSheetName = document.getElementById('reportSheetName').value;

            if (!managerValue || !selectedSiteName || !selectedReportSheetName) {
                responseDiv.textContent = '매니저, 담당 사이트, 보고서 시트 이름을 모두 선택해주세요.';
                lastWeekReportButton.textContent = '지난 주 보고서 조회';
                lastWeekReportButton.style.backgroundColor = '#9C27B0';
                lastWeekReportButton.disabled = false;
                return;
            }

            // 1주일 이전 시트 이름 계산
            const lastWeekSheetName = getLastWeekDate(selectedReportSheetName);
            if (!lastWeekSheetName) {
                responseDiv.textContent = '지난 주 시트 이름을 계산할 수 없습니다.';
                lastWeekReportButton.textContent = '지난 주 보고서 조회';
                lastWeekReportButton.style.backgroundColor = '#dc3545';
                lastWeekReportButton.disabled = false;
                return;
            }

            // 스프레드시트의 열 순서를 정의합니다. (데이터 쓰기와 동일)
            const COLUMN_ORDER = ['SITE명', '담당자', '금주 한 일'];

            try {
                // 지난 주 시트의 전체 데이터 가져오기 (site_name 위치 찾기 위함)
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `${lastWeekSheetName}!A:Z`,
                });
                const sheetData = response.result.values || [];

                // site_name 위치 찾기
                const { row, col } = findCellCoordinates(sheetData, selectedSiteName, lastWeekSheetName, COLUMN_ORDER);

                if (row === -1 || col === -1) {
                    throw new Error(`담당 사이트 '${selectedSiteName}'를 지난 주 시트 '${lastWeekSheetName}'에서 찾을 수 없습니다.`);
                }

                // 읽어올 셀 범위 계산 (쓰기 위치와 동일하게)
                let thisWeekTasksRelativeOffset = COLUMN_ORDER.indexOf('금주 한 일');
                thisWeekTasksRelativeOffset += 1; // O열로 이동하기 위해 1 추가

                // 예외 사이트에 따라 읽어올 범위 결정
                const rangesToRead = [
                    `'${lastWeekSheetName}'!${columnToLetter(col + thisWeekTasksRelativeOffset)}${row + 1}`, // 금주 한 일
                    `'${lastWeekSheetName}'!${columnToLetter(col + thisWeekTasksRelativeOffset)}${row + 2}`  // 차주 할 일
                ];
                
                // 예외 사이트가 아닌 경우에만 고객 요청사항 범위 추가
                if (!sitesWithoutCustomerRequests.includes(selectedSiteName)) {
                    rangesToRead.push(`'${lastWeekSheetName}'!${columnToLetter(col + thisWeekTasksRelativeOffset)}${row + 3}`); // 고객 요청사항
                }

                console.log('Reading last week data from ranges:', rangesToRead);

                const readResponse = await gapi.client.sheets.spreadsheets.values.batchGet({
                    spreadsheetId: SPREADSHEET_ID,
                    ranges: rangesToRead,
                });
                console.log('Read Last Week API Response:', readResponse);

                const values = readResponse.result.valueRanges || [];

                // 리스트 필드에 데이터 출력 (▶는 setListData에서 자동 제거됨)
                const thisWeekTasks = (values[0] && values[0].values && values[0].values[0]) ? values[0].values[0][0] : '';
                const nextWeekTasks = (values[1] && values[1].values && values[1].values[0]) ? values[1].values[0][0] : '';
                setListData('this_week_tasks_container', thisWeekTasks);
                setListData('next_week_tasks_container', nextWeekTasks);
                
                // 예외 사이트가 아닌 경우에만 고객 요청사항 읽기
                if (!sitesWithoutCustomerRequests.includes(selectedSiteName)) {
                    // 예외 사이트가 아닌 경우 values[2]가 고객 요청사항
                    const customerRequests = (values[2] && values[2].values && values[2].values[0]) ? values[2].values[0][0] : '';
                    setListData('customer_requests_container', customerRequests);
                } else {
                    setListData('customer_requests_container', ''); // 예외 사이트는 빈 값으로 설정
                }

                // Google Sheets 링크 생성 (지난 주 보고서 시트에 따라)
                const selectedOption = document.getElementById('reportSheetName').selectedOptions[0];
                const reportSheetId = selectedOption ? selectedOption.dataset.sheetId : '';
                const sheetUrl = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/edit#gid=${reportSheetId}`;
                responseDiv.innerHTML = `
                    지난 주 보고서 데이터를 성공적으로 조회했습니다! (${lastWeekSheetName})<br>
                    <a href="${sheetUrl}" target="_blank" style="color: #1976d2; text-decoration: underline; margin-top: 10px; display: inline-block;">
                        📊 Google Sheets에서 확인하기
                    </a>
                `;
                lastWeekReportButton.textContent = '조회 완료';
                lastWeekReportButton.style.backgroundColor = '#6c757d';
                // 조회 완료 후에도 다시 조회할 수 있도록 활성화 상태 유지
                lastWeekReportButton.disabled = false; 

                // 3초 뒤 버튼 상태 초기화
                setTimeout(() => {
                    lastWeekReportButton.textContent = '지난 주 보고서 조회';
                    lastWeekReportButton.style.backgroundColor = '#9C27B0'; // 보라색 (지난 주 보고서 조회)
                    lastWeekReportButton.disabled = false;
                }, 3000); // 3초 (3000ms)

            } catch (err) {
                console.error('Error reading last week report data:', err);
                responseDiv.textContent = '지난 주 보고서 데이터 조회 중 오류가 발생했습니다: ' + (err.result?.error?.message || err.message || JSON.stringify(err));
                lastWeekReportButton.textContent = '지난 주 보고서 조회';
                lastWeekReportButton.style.backgroundColor = '#dc3545'; // 오류 시 빨간색
                lastWeekReportButton.disabled = false;
            }
        }

        // 보고서 조회 버튼 이벤트 리스너
        document.getElementById('readReportButton').addEventListener('click', readReportData);

        // 지난 주 보고서 조회 버튼 이벤트 리스너
        document.getElementById('readLastWeekReportButton').addEventListener('click', readLastWeekReportData);

        // 제출 완료 모달 관련 함수
        function showSubmitSuccessModal(sheetUrl) {
            const modal = document.getElementById('submitSuccessModal');
            const linkDiv = document.getElementById('submitSuccessSheetLink');
            
            // Google Sheets 링크 설정
            linkDiv.innerHTML = `
                <a href="${sheetUrl}" target="_blank" style="
                    color: #4CAF50;
                    text-decoration: none;
                    font-weight: bold;
                    display: inline-flex;
                    align-items: center;
                    gap: 8px;
                    padding: 10px 20px;
                    border: 2px solid #4CAF50;
                    border-radius: 5px;
                    transition: all 0.3s ease;
                " onmouseover="this.style.background='#4CAF50'; this.style.color='white'" 
                   onmouseout="this.style.background='transparent'; this.style.color='#4CAF50'">
                    📊 Google Sheets에서 확인하기
                </a>
            `;
            
            modal.style.display = 'block';
        }

        function closeSubmitSuccessModal() {
            const modal = document.getElementById('submitSuccessModal');
            modal.style.display = 'none';
        }

        // 사용법 팝업 이벤트 리스너
        const helpButton = document.getElementById('helpButton');
        const helpModal = document.getElementById('helpModal');
        const closeButton = document.querySelector('.close');

        helpButton.addEventListener('click', function() {
            helpModal.style.display = 'block';
        });

        closeButton.addEventListener('click', function() {
            helpModal.style.display = 'none';
        });

        // 배경 클릭 시 모달 닫기
        window.addEventListener('click', function(event) {
            const submitSuccessModal = document.getElementById('submitSuccessModal');
            
            if (event.target === helpModal) {
                helpModal.style.display = 'none';
            }
            if (event.target === submitSuccessModal) {
                closeSubmitSuccessModal();
            }
        });

        // ESC 키로 모달 닫기
        document.addEventListener('keydown', function(event) {
            const submitSuccessModal = document.getElementById('submitSuccessModal');
            
            if (event.key === 'Escape' && helpModal.style.display === 'block') {
                helpModal.style.display = 'none';
            }
            if (event.key === 'Escape' && submitSuccessModal.style.display === 'block') {
                closeSubmitSuccessModal();
            }
        });

        // 폼 내부에서 엔터키로 제출되는 것을 방지 (데스크톱 + 모바일)
        document.getElementById('reportForm').addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                // INPUT 필드에서만 엔터키 제출 방지, TEXTAREA는 허용
                if (event.target.tagName === 'INPUT') {
                    event.preventDefault();
                    console.log('Enter key submission blocked in input fields');
                }
            }
        });

        // 모바일에서 가상 키보드의 "완료" 버튼으로 제출되는 것을 방지
        document.getElementById('reportForm').addEventListener('keypress', function(event) {
            if (event.key === 'Enter' || event.keyCode === 13) {
                // INPUT 필드에서만 제출 방지, TEXTAREA는 줄바꿈 허용
                if (event.target.tagName === 'INPUT') {
                    event.preventDefault();
                    console.log('Mobile keyboard submission blocked in input fields');
                }
            }
        });


        // 리스트 데이터 복사 함수
        async function copyListData(containerId) {
            try {
                const listData = getListData(containerId);
                
                if (!listData || listData.trim() === '') {
                    alert('복사할 내용이 없습니다.');
                    return;
                }
                
                await navigator.clipboard.writeText(listData);
                
                // 복사 버튼 시각적 피드백
                const copyBtn = document.querySelector(`#${containerId} .copy-btn`);
                const originalText = copyBtn.innerHTML;
                const originalClass = copyBtn.className;
                
                copyBtn.innerHTML = '✓';
                copyBtn.className = 'copy-btn copied';
                
                // 2초 후 원래 상태로 복원
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.className = originalClass;
                }, 2000);
                
                console.log('복사된 내용:', listData);
                
            } catch (err) {
                console.error('복사 실패:', err);
                alert('복사에 실패했습니다. 브라우저가 클립보드 접근을 지원하지 않을 수 있습니다.');
            }
        }

        // 리스트 데이터 붙여넣기 함수
        async function pasteListData(containerId) {
            try {
                const pasteBtn = document.querySelector(`#${containerId} .paste-btn`);
                
                // 클립보드 읽기 시도
                let clipboardText = '';
                try {
                    clipboardText = await navigator.clipboard.readText();
                } catch (clipboardErr) {
                    console.warn('클립보드 읽기 실패, 사용자 입력 방식으로 전환:', clipboardErr);
                    
                    // Fallback: 사용자에게 직접 입력 요청
                    const userInput = prompt('붙여넣기할 내용을 입력하세요 (Ctrl+V로 붙여넣기 가능):');
                    if (userInput === null) {
                        return; // 사용자가 취소한 경우
                    }
                    clipboardText = userInput;
                }
                
                if (!clipboardText || clipboardText.trim() === '') {
                    alert('붙여넣기할 내용이 없습니다.');
                    return;
                }
                
                // 클립보드 내용을 리스트로 파싱하여 설정
                setListData(containerId, clipboardText);
                
                // 붙여넣기 버튼 시각적 피드백
                const originalText = pasteBtn.innerHTML;
                const originalClass = pasteBtn.className;
                
                pasteBtn.innerHTML = '✓';
                pasteBtn.className = 'paste-btn pasted';
                
                // 2초 후 원래 상태로 복원
                setTimeout(() => {
                    pasteBtn.innerHTML = originalText;
                    pasteBtn.className = originalClass;
                }, 2000);
                
                console.log('붙여넣기된 내용:', clipboardText);
                
            } catch (err) {
                console.error('붙여넣기 실패:', err);
                alert('붙여넣기에 실패했습니다. 다시 시도해주세요.');
            }
        }

        // 개별 리스트 항목 복사 함수
        async function copyListItemData(button) {
            try {
                const listItem = button.closest('.list-input-item');
                const input = listItem.querySelector('.list-input');
                const dateInput = listItem.querySelector('.date-input');
                
                let itemData = input.value.trim();
                
                // 고객 요청사항인 경우 날짜 정보 추가
                if (dateInput && dateInput.value) {
                    const date = new Date(dateInput.value);
                    const formattedDate = `${date.getFullYear().toString().slice(-2)}.${(date.getMonth() + 1).toString().padStart(2, '0')}.${date.getDate().toString().padStart(2, '0')}`;
                    itemData = `(발생일 : ${formattedDate}) ${itemData}`;
                }
                
                // 작업 대상 체크박스 정보는 복사 시 제외 (사용자 요청에 따라)
                // const checkboxes = listItem.querySelectorAll('input[type="checkbox"]:checked');
                // if (checkboxes.length > 0) {
                //     const targets = Array.from(checkboxes).map(cb => cb.value).join(',');
                //     itemData = `[${targets}] ${itemData}`;
                // }
                
                if (!itemData) {
                    alert('복사할 내용이 없습니다.');
                    return;
                }
                
                await navigator.clipboard.writeText(itemData);
                
                // 복사 버튼 시각적 피드백
                const originalText = button.innerHTML;
                const originalClass = button.className;
                
                button.innerHTML = '✓';
                button.className = 'copy-btn copied';
                
                // 2초 후 원래 상태로 복원
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.className = originalClass;
                }, 2000);
                
                console.log('복사된 항목 내용:', itemData);
                
            } catch (err) {
                console.error('항목 복사 실패:', err);
                alert('복사에 실패했습니다. 브라우저가 클립보드 접근을 지원하지 않을 수 있습니다.');
            }
        }

        // 개별 리스트 항목 붙여넣기 함수
        async function pasteListItemData(button) {
            try {
                const listItem = button.closest('.list-input-item');
                const input = listItem.querySelector('.list-input');
                
                // 클립보드 읽기 시도
                let clipboardText = '';
                try {
                    clipboardText = await navigator.clipboard.readText();
                } catch (clipboardErr) {
                    console.warn('클립보드 읽기 실패, 사용자 입력 방식으로 전환:', clipboardErr);
                    
                    // Fallback: 사용자에게 직접 입력 요청
                    const userInput = prompt('붙여넣기할 내용을 입력하세요 (Ctrl+V로 붙여넣기 가능):');
                    if (userInput === null) {
                        return; // 사용자가 취소한 경우
                    }
                    clipboardText = userInput;
                }
                
                if (!clipboardText || clipboardText.trim() === '') {
                    alert('붙여넣기할 내용이 없습니다.');
                    return;
                }
                
                // 클립보드 내용을 입력창에 설정
                input.value = clipboardText.trim();
                
                // 붙여넣기 버튼 시각적 피드백
                const originalText = button.innerHTML;
                const originalClass = button.className;
                
                button.innerHTML = '✓';
                button.className = 'paste-btn pasted';
                
                // 2초 후 원래 상태로 복원
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.className = originalClass;
                }, 2000);
                
                console.log('붙여넣기된 항목 내용:', clipboardText);
                
            } catch (err) {
                console.error('항목 붙여넣기 실패:', err);
                alert('붙여넣기에 실패했습니다. 다시 시도해주세요.');
            }
        }

        // 섹션 활성화/비활성화 함수
        function toggleSection(containerId, isChecked) {
            const container = document.getElementById(containerId);
            const addButton = container.nextElementSibling;
            
            if (isChecked) {
                // "없음" 체크 시 섹션 비활성화
                container.classList.add('section-disabled');
                if (addButton && addButton.classList.contains('add-item-btn')) {
                    addButton.style.display = 'none';
                }
                // 기존 내용 초기화
                container.innerHTML = '';
            } else {
                // "없음" 체크 해제 시 섹션 활성화
                container.classList.remove('section-disabled');
                if (addButton && addButton.classList.contains('add-item-btn')) {
                    addButton.style.display = 'block';
                }
                // 빈 항목 추가
                addListItem(containerId);
            }
        }

        // 리스트 항목 추가 함수
        function addListItem(containerId) {
            const container = document.getElementById(containerId);
            const newItem = document.createElement('div');
            newItem.className = 'list-input-item';
            
            // 고객 요청사항인 경우 날짜 입력 칸 추가
            if (containerId === 'customer_requests_container') {
                newItem.className = 'list-input-item customer-request-item';
                const itemIndex = container.children.length + 1;
                newItem.innerHTML = `
                    <div class="target-label">(발생일)</div>
                    <div class="target-checkboxes">
                        <div class="date-label">(발생일)</div>
                        <input type="date" class="date-input" title="발생일 선택">
                        <div class="copy-paste-container">
                            <button type="button" class="copy-btn" onclick="copyListItemData(this)" title="이 항목 복사">Copy</button>
                            <button type="button" class="paste-btn" onclick="pasteListItemData(this)" title="이 항목에 붙여넣기">Paste</button>
                        </div>
                    </div>
                    <textarea placeholder="고객 요청사항을 입력하세요..." class="list-input" rows="3"></textarea>
                    <button type="button" class="remove-btn" onclick="removeListItem(this)">×</button>
                `;
            } else if (containerId === 'this_week_tasks_container' || containerId === 'next_week_tasks_container') {
                // 금주 한 일, 향후 할 일인 경우 작업 대상 선택 추가
                newItem.className = 'list-input-item customer-request-item';
                const itemIndex = container.children.length + 1;
                const prefix = containerId === 'this_week_tasks_container' ? 'this_week' : 'next_week';
                const placeholder = containerId === 'this_week_tasks_container' ? '금주 한 일을 입력하세요...' : '향후 할 일을 입력하세요...';
                
                newItem.innerHTML = `
                    <div class="target-label">(작업 대상)</div>
                    <div class="target-checkboxes">
                        <div class="target-checkbox-item">
                            <input type="checkbox" id="${prefix}_dev_${itemIndex}" name="${prefix}_target_${itemIndex}" value="개발계">
                            <label for="${prefix}_dev_${itemIndex}">개발계</label>
                        </div>
                        <div class="target-checkbox-item">
                            <input type="checkbox" id="${prefix}_ops_${itemIndex}" name="${prefix}_target_${itemIndex}" value="운영계">
                            <label for="${prefix}_ops_${itemIndex}">운영계</label>
                        </div>
                        <div class="target-checkbox-item">
                            <input type="checkbox" id="${prefix}_etc_${itemIndex}" name="${prefix}_target_${itemIndex}" value="기타">
                            <label for="${prefix}_etc_${itemIndex}">기타</label>
                        </div>
                        <div class="copy-paste-container">
                            <button type="button" class="copy-btn" onclick="copyListItemData(this)" title="이 항목 복사">Copy</button>
                            <button type="button" class="paste-btn" onclick="pasteListItemData(this)" title="이 항목에 붙여넣기">Paste</button>
                        </div>
                    </div>
                    <textarea placeholder="${placeholder}" class="list-input" rows="3"></textarea>
                    <button type="button" class="remove-btn" onclick="removeListItem(this)">×</button>
                `;
            } else {
                newItem.innerHTML = `
                    <textarea placeholder="항목을 입력하세요..." class="list-input" rows="3"></textarea>
                    <button type="button" class="remove-btn" onclick="removeListItem(this)">×</button>
                `;
            }
            container.appendChild(newItem);
        }

        // 리스트 항목 제거 함수
        function removeListItem(button) {
            const container = button.closest('.list-input-container');
            const items = container.querySelectorAll('.list-input-item');
            const currentItem = button.closest('.list-input-item');
            
            if (items.length > 1) {
                // 여러 항목이 있으면 삭제
                currentItem.remove();
            } else {
                // 첫 번째 항목이면 값만 비우기
                const textInput = currentItem.querySelector('.list-input');
                const dateInput = currentItem.querySelector('.date-input');
                const checkboxes = currentItem.querySelectorAll('input[type="checkbox"]');
                
                textInput.value = '';
                if (dateInput) {
                    dateInput.value = ''; // 날짜도 초기화
                }
                // 체크박스도 초기화
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                textInput.focus(); // 포커스 이동
            }
        }

        // 리스트 데이터를 텍스트로 변환하는 함수 (Sheet용 - 첫 줄 제외하고 ▶ 추가)
        function getListData(containerId) {
            const container = document.getElementById(containerId);
            
            // "없음" 체크박스 확인
            let noneCheckboxId;
            if (containerId === 'this_week_tasks_container') {
                noneCheckboxId = 'this_week_none';
            } else if (containerId === 'next_week_tasks_container') {
                noneCheckboxId = 'next_week_none';
            } else if (containerId === 'customer_requests_container') {
                noneCheckboxId = 'customer_requests_none';
            }
            
            const noneCheckbox = document.getElementById(noneCheckboxId);
            
            console.log(`getListData 체크: ${containerId} -> ${noneCheckboxId}, 체크박스 존재: ${!!noneCheckbox}, 체크됨: ${noneCheckbox?.checked}`);
            
            if (noneCheckbox && noneCheckbox.checked) {
                console.log(`"없음" 체크됨: ${containerId} -> ${noneCheckboxId}`);
                return '없음';
            }
            
            const items = container.querySelectorAll('.list-input-item');
            const itemTexts = [];
            
            Array.from(items).forEach((item, itemIndex) => {
                const textInput = item.querySelector('.list-input');
                const dateInput = item.querySelector('.date-input');
                const checkboxes = item.querySelectorAll('input[type="checkbox"]:checked');
                
                if (!textInput || textInput.value.trim() === '') {
                    return; // 텍스트가 비어있으면 제외
                }
                
                const text = textInput.value.trim();
                const date = dateInput ? dateInput.value : '';
                
                // textarea의 여러 줄을 각각 처리
                const lines = text.split('\n').filter(line => line.trim() !== '');
                const itemLines = [];
                
                lines.forEach((line, lineIndex) => {
                    // 기존 텍스트에서 ▶ 제거하고 깨끗한 텍스트만 추출
                    const cleanValue = line.replace(/^▶\s*/, '').trim();
                    
                    // 공백이 아닌 경우에만 처리
                    if (cleanValue === '') {
                        return;
                    }
                    
                    let finalValue = cleanValue;
                    
                    // 첫 줄에만 작업 대상과 날짜 추가
                    if (lineIndex === 0) {
                        // 작업 대상 선택이 있는 경우 (금주 한 일, 향후 할 일)
                        if (checkboxes.length > 0 && (containerId === 'this_week_tasks_container' || containerId === 'next_week_tasks_container')) {
                            const selectedTargets = Array.from(checkboxes).map(cb => cb.value);
                            finalValue = `[${selectedTargets.join(',')}] ${cleanValue}`;
                        }
                        
                        // 고객 요청사항인 경우 날짜 추가
                        if (containerId === 'customer_requests_container' && date) {
                            // 날짜 형식을 YY.MM.DD로 변환
                            const dateObj = new Date(date);
                            const formattedDate = `${dateObj.getFullYear().toString().slice(-2)}.${(dateObj.getMonth() + 1).toString().padStart(2, '0')}.${dateObj.getDate().toString().padStart(2, '0')}`;
                            finalValue = `${cleanValue} (발생일 : ${formattedDate})`;
                        }
                    }
                    
                    itemLines.push(finalValue);
                });
                
                // 각 항목의 줄들을 줄바꿈으로 연결
                if (itemLines.length > 0) {
                    itemTexts.push(itemLines.join('\n'));
                }
            });
            
            // 첫 번째 항목은 ▶ 없이, 나머지 항목은 첫 줄에 ▶ 추가
            const values = itemTexts.map((text, index) => {
                if (index === 0) {
                    return text;
                } else {
                    // 첫 줄에만 ▶ 추가
                    const lines = text.split('\n');
                    lines[0] = `▶ ${lines[0]}`;
                    return lines.join('\n');
                }
            });
            
            const result = values.join('\n');
            console.log(`getListData result for ${containerId}:`, result);
            return result;
        }

        // 리스트 데이터를 텍스트로 변환하는 함수 (표시용 - ▶ 없이)
        function getListDataForDisplay(containerId) {
            const container = document.getElementById(containerId);
            const inputs = container.querySelectorAll('.list-input');
            const values = Array.from(inputs)
                .map(input => input.value.trim())
                .filter(value => value !== '');
            return values.join('\n');
        }

        // 텍스트를 리스트로 설정하는 함수 (▶ 제거하여 표시)
        function setListData(containerId, text) {
            const container = document.getElementById(containerId);
            
            // "없음" 체크박스 확인
            let noneCheckboxId;
            if (containerId === 'this_week_tasks_container') {
                noneCheckboxId = 'this_week_none';
            } else if (containerId === 'next_week_tasks_container') {
                noneCheckboxId = 'next_week_none';
            } else if (containerId === 'customer_requests_container') {
                noneCheckboxId = 'customer_requests_none';
            }
            
            const noneCheckbox = document.getElementById(noneCheckboxId);
            
            if (text.trim() === '없음') {
                // "없음" 데이터인 경우 체크박스 체크하고 섹션 비활성화
                if (noneCheckbox) {
                    noneCheckbox.checked = true;
                    toggleSection(containerId, true);
                }
                return;
            }
            
            // "없음"이 아닌 경우 체크박스 해제하고 섹션 활성화
            if (noneCheckbox) {
                noneCheckbox.checked = false;
                toggleSection(containerId, false);
            }
            
            const lines = text.split('\n').filter(line => line.trim() !== '');
            
            // 기존 항목들 제거
            container.innerHTML = '';
            
            // ▶를 기준으로 항목 그룹 나누기
            const itemGroups = [];
            let currentGroup = [];
            
            lines.forEach((line, index) => {
                const trimmedLine = line.trim();
                
                // ▶로 시작하는 경우 또는 첫 줄인 경우
                if (trimmedLine.startsWith('▶') || index === 0) {
                    // 이전 그룹이 있으면 저장
                    if (currentGroup.length > 0) {
                        itemGroups.push(currentGroup);
                    }
                    // 새 그룹 시작
                    currentGroup = [trimmedLine];
                } else {
                    // 현재 그룹에 추가
                    currentGroup.push(trimmedLine);
                }
            });
            
            // 마지막 그룹 추가
            if (currentGroup.length > 0) {
                itemGroups.push(currentGroup);
            }
            
            // 각 그룹마다 별도의 항목 생성
            itemGroups.forEach((group, groupIndex) => {
                let dateValue = '';
                let selectedTargets = [];
                let cleanLines = [];
                
                group.forEach((line, lineIndex) => {
                    // ▶ 기호와 공백 제거
                    let cleanLine = line.replace(/^▶\s*/g, '').trim();
                    
                    // 첫 줄에서만 작업 대상과 날짜 파싱
                    if (lineIndex === 0) {
                        // 작업 대상 파싱 (금주 한 일, 향후 할 일)
                        if (containerId === 'this_week_tasks_container' || containerId === 'next_week_tasks_container') {
                            const targetMatch = cleanLine.match(/^\[([^\]]+)\]\s*(.*)$/);
                            if (targetMatch) {
                                selectedTargets = targetMatch[1].split(',').map(t => t.trim());
                                cleanLine = targetMatch[2].trim();
                            }
                        }
                        
                        // 고객 요청사항인 경우 날짜 파싱
                        if (containerId === 'customer_requests_container') {
                            const dateMatch = cleanLine.match(/\(발생일\s*:\s*(\d{2}\.\d{2}\.\d{2})\)$/);
                            if (dateMatch) {
                                // 날짜 부분 제거
                                cleanLine = cleanLine.replace(/\s*\(발생일\s*:\s*\d{2}\.\d{2}\.\d{2}\)$/, '').trim();
                                
                                // YY.MM.DD 형식을 YYYY-MM-DD로 변환
                                const dateStr = dateMatch[1];
                                const [year, month, day] = dateStr.split('.');
                                const fullYear = '20' + year; // 20XX년으로 변환
                                dateValue = `${fullYear}-${month}-${day}`;
                            }
                        }
                    }
                    
                    cleanLines.push(cleanLine);
                });
                
                // 그룹의 모든 줄을 줄바꿈으로 연결
                const textareaValue = cleanLines.join('\n');
                
                const newItem = document.createElement('div');
                newItem.className = 'list-input-item';
                
                // 고객 요청사항인 경우 날짜 입력 칸 추가
                if (containerId === 'customer_requests_container') {
                    newItem.className = 'list-input-item customer-request-item';
                    newItem.innerHTML = `
                        <div class="target-label">(발생일)</div>
                        <div class="target-checkboxes">
                            <div class="date-label">(발생일)</div>
                            <input type="date" class="date-input" value="${dateValue}" title="발생일 선택">
                            <div class="copy-paste-container">
                                <button type="button" class="copy-btn" onclick="copyListItemData(this)" title="이 항목 복사">Copy</button>
                                <button type="button" class="paste-btn" onclick="pasteListItemData(this)" title="이 항목에 붙여넣기">Paste</button>
                            </div>
                        </div>
                        <textarea class="list-input" rows="3">${textareaValue}</textarea>
                        <button type="button" class="remove-btn" onclick="removeListItem(this)">×</button>
                    `;
                } else if (containerId === 'this_week_tasks_container' || containerId === 'next_week_tasks_container') {
                    // 금주 한 일, 향후 할 일인 경우 작업 대상 선택 추가
                    newItem.className = 'list-input-item customer-request-item';
                    const itemIndex = groupIndex + 1;
                    const prefix = containerId === 'this_week_tasks_container' ? 'this_week' : 'next_week';
                    const placeholder = containerId === 'this_week_tasks_container' ? '금주 한 일을 입력하세요...' : '향후 할 일을 입력하세요...';
                    
                    // 선택된 작업 대상에 따라 체크박스 상태 설정
                    const devChecked = selectedTargets.includes('개발계') ? 'checked' : '';
                    const opsChecked = selectedTargets.includes('운영계') ? 'checked' : '';
                    const etcChecked = selectedTargets.includes('기타') ? 'checked' : '';
                    
                    newItem.innerHTML = `
                        <div class="target-label">(작업 대상)</div>
                        <div class="target-checkboxes">
                            <div class="target-checkbox-item">
                                <input type="checkbox" id="${prefix}_dev_${itemIndex}" name="${prefix}_target_${itemIndex}" value="개발계" ${devChecked}>
                                <label for="${prefix}_dev_${itemIndex}">개발계</label>
                            </div>
                            <div class="target-checkbox-item">
                                <input type="checkbox" id="${prefix}_ops_${itemIndex}" name="${prefix}_target_${itemIndex}" value="운영계" ${opsChecked}>
                                <label for="${prefix}_ops_${itemIndex}">운영계</label>
                            </div>
                            <div class="target-checkbox-item">
                                <input type="checkbox" id="${prefix}_etc_${itemIndex}" name="${prefix}_target_${itemIndex}" value="기타" ${etcChecked}>
                                <label for="${prefix}_etc_${itemIndex}">기타</label>
                            </div>
                            <div class="copy-paste-container">
                                <button type="button" class="copy-btn" onclick="copyListItemData(this)" title="이 항목 복사">Copy</button>
                                <button type="button" class="paste-btn" onclick="pasteListItemData(this)" title="이 항목에 붙여넣기">Paste</button>
                            </div>
                        </div>
                        <textarea placeholder="${placeholder}" class="list-input" rows="3">${textareaValue}</textarea>
                        <button type="button" class="remove-btn" onclick="removeListItem(this)">×</button>
                    `;
                } else {
                    newItem.innerHTML = `
                        <textarea class="list-input" rows="3">${textareaValue}</textarea>
                        <button type="button" class="remove-btn" onclick="removeListItem(this)">×</button>
                    `;
                }
                container.appendChild(newItem);
            });
            
            // 빈 항목이 없으면 하나 추가
            if (itemGroups.length === 0) {
                addListItem(containerId);
            }
        }

        /**
         * 시트 데이터에서 특정 site_name을 찾아 해당 셀의 0-based 행과 열 인덱스를 반환합니다.
         * site_name은 'SITE명' 열(B열, G열, L열 등)에 위치한다고 가정합니다.
         * @param {Array<Array<string>>} sheetData 시트의 전체 2차원 배열 데이터
         * @param {string} siteName 찾을 site_name
         * @param {string} sheetName 현재 시트 이름
         * @param {Array<string>} columnOrder 스프레드시트의 열 순서 (예: ['SITE명', '담당자', '금주 한 일'])
         * @returns {{row: number, col: number}} site_name이 발견된 0-based 행 및 열 인덱스. 찾지 못하면 {row: -1, col: -1}.
         */
        function findCellCoordinates(sheetData, siteName, sheetName, columnOrder) {
            const siteNameColIndexInOrder = columnOrder.indexOf('SITE명');
            
            for (let r = 0; r < sheetData.length; r++) {
                const row = sheetData[r];
                for (let c = 0; c < row.length; c++) {
                    // SITE명 열에 해당하는 경우에만 검색
                    // 여기서는 columnOrder의 'SITE명'이 실제 Sheets의 어느 열에 해당하는지를 알아야 합니다.
                    // 간단화를 위해, 실제 Sheets에서 SITE명이 특정 열에 규칙적으로 나타난다고 가정합니다.
                    // 예를 들어, B, G, L 열에 SITE명이 있다면, c % 5 === 1 (0-based) 과 같은 규칙을 사용할 수 있습니다.
                    // 현재는 모든 셀을 검색합니다. 보다 정확한 로직이 필요하면 수정해야 합니다.
                    if (row[c] === siteName) {
                         // 여기서 `c`는 site_name이 발견된 실제 0-based 열 인덱스입니다。
                         // 이 `c`를 기준으로 다른 컬럼의 오프셋을 계산합니다.
                        return { row: r, col: c };
                    }
                }
            }
            return { row: -1, col: -1 };
        }

        /**
         * 0-based 열 인덱스를 A1 표기법의 열 문자(예: 0 -> A, 25 -> Z, 26 -> AA)로 변환합니다.
         * @param {number} colIndex 0-based 열 인덱스
         * @returns {string} A1 표기법 열 문자
         */
        function columnToLetter(colIndex) {
            let temp, letter = '';
            while (colIndex >= 0) {
                temp = colIndex % 26;
                letter = String.fromCharCode(temp + 65) + letter;
                colIndex = Math.floor(colIndex / 26) - 1;
            }
            return letter;
        }

        // 페이지 로드 시 매핑 데이터 로드
        window.addEventListener('DOMContentLoaded', function() {
            loadManagerSiteMapping();
        });
    </script>

    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
