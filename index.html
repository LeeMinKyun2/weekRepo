<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주간 업무 보고</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 600px; margin: auto; }
        h1 { text-align: center; color: #333; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea { resize: vertical; min-height: 100px; }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover { background-color: #45a049; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #confirmSiteButton {
            background-color: #2196F3;
            margin-left: 10px;
            padding: 8px 16px;
            font-size: 14px;
        }
        #confirmSiteButton:hover:not(:disabled) { background-color: #1976D2; }
        .response { margin-top: 20px; padding: 10px; background-color: #e2e2e2; border-radius: 4px; }
        
        /* 헤더 섹션 스타일 */
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .help-button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .help-button:hover {
            background-color: #1976D2;
        }
        
        /* 모달 스타일 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #ddd;
            background-color: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #333;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .step {
            display: flex;
            margin-bottom: 20px;
            align-items: flex-start;
        }
        
        .step-number {
            font-size: 24px;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .step-content {
            flex: 1;
            line-height: 1.6;
        }
        
        .step-content strong {
            color: #2196F3;
            font-size: 16px;
        }
        
        .account-info {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            border-left: 4px solid #2196F3;
        }
        
        .account-info h3 {
            margin: 0 0 10px 0;
            color: #1976D2;
        }
        
        .account-info p {
            margin: 5px 0;
            font-family: monospace;
            background-color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
        }
        
        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .header-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .help-button {
                margin-top: 10px;
                align-self: flex-end;
            }
            
            .modal-content {
                width: 95%;
                margin: 5% auto;
                max-height: 90vh;
            }
            
            .modal-header {
                padding: 15px;
            }
            
            .modal-header h2 {
                font-size: 18px;
            }
            
            .modal-body {
                padding: 15px;
            }
            
            .step {
                flex-direction: column;
                text-align: center;
                margin-bottom: 15px;
            }
            
            .step-number {
                margin-right: 0;
                margin-bottom: 8px;
                font-size: 20px;
            }
            
            .step-content {
                font-size: 14px;
            }
            
            .step-content strong {
                font-size: 14px;
            }
            
            .account-info {
                padding: 12px;
                margin-top: 15px;
            }
            
            .account-info h3 {
                font-size: 16px;
            }
            
            .account-info p {
                font-size: 13px;
                padding: 4px 8px;
            }
        }
        
        /* 매우 작은 화면 (320px 이하) */
        @media (max-width: 480px) {
            .modal-content {
                width: 98%;
                margin: 2% auto;
                max-height: 95vh;
            }
            
            .modal-header {
                padding: 12px;
            }
            
            .modal-header h2 {
                font-size: 16px;
            }
            
            .modal-body {
                padding: 12px;
            }
            
            .step {
                margin-bottom: 12px;
            }
            
            .step-number {
                font-size: 18px;
            }
            
            .step-content {
                font-size: 13px;
            }
            
            .account-info {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-section">
            <h1>주간 업무 보고 입력</h1>
            <button id="helpButton" class="help-button">📖 사용법</button>
        </div>
        <form id="reportForm">
            <div class="form-group">
                <label for="manager">매니저 이름:</label>
                <input type="text" id="searchManager" placeholder="매니저 이름 검색...">
                <select id="manager" name="manager" required>
                    <option value="">선택하세요</option>
                </select>
            </div>
            <div class="form-group">
                <label for="site_name">담당 사이트:</label>
                <input type="text" id="searchSite" placeholder="담당 사이트 검색...">
                <select id="site_name" name="site_name" required>
                    <option value="">선택하세요</option>
                </select>
            </div>
            <div class="form-group">
                <label for="reportSheetName">보고서 시트 이름:</label>
                <select id="reportSheetName" name="reportSheetName" required>
                    <option value="">선택하세요</option>
                </select>
            </div>
            <div class="form-group">
                <button type="button" id="queryDropdownsButton" disabled>매니저/사이트 목록 조회</button>
                <button type="button" id="confirmSiteButton" disabled>고정/선택</button>
            </div>
            <div class="form-group">
                <button type="button" id="readReportButton" disabled>보고서 조회</button>
            </div>
            <div class="form-group">
                <label for="this_week_tasks">금주 한 일:</label>
                <textarea id="this_week_tasks" name="this_week_tasks" required></textarea>
            </div>
            <div class="form-group">
                <label for="next_week_tasks">차주 할 일:</label>
                <textarea id="next_week_tasks" name="next_week_tasks" required></textarea>
            </div>
            <div class="form-group">
                <label for="customer_requests">고객 요청사항:</label>
                <textarea id="customer_requests" name="customer_requests"></textarea>
            </div>
            <button type="submit" disabled>보고서 제출</button>
        </form>
        <div id="response" class="response" style="display: none;"></div>
    </div>

    <!-- 사용법 팝업 모달 -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📖 사용법</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="step">
                    <div class="step-number">1️⃣</div>
                    <div class="step-content">
                        <strong>매니저/사이트 목록 조회</strong><br>
                        "매니저/사이트 목록 조회" 버튼을 클릭하여 데이터를 불러옵니다.
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-number">2️⃣</div>
                    <div class="step-content">
                        <strong>정보 선택</strong><br>
                        매니저 이름, 담당 사이트, 보고서 시트를 선택합니다.
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-number">3️⃣</div>
                    <div class="step-content">
                        <strong>고정/선택</strong><br>
                        "고정/선택" 버튼을 클릭하여 사이트별 설정을 확인합니다.
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-number">4️⃣</div>
                    <div class="step-content">
                        <strong>보고서 제출</strong><br>
                        텍스트를 입력한 후 "보고서 제출" 버튼을 클릭합니다.
                    </div>
                </div>
                
                <div class="account-info">
                    <h3>🔐 Google 공용 계정</h3>
                    <p><strong>ID:</strong> interezen502@gmail.com</p>
                    <p><strong>PW:</strong> inter502</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Google API 설정
        const CLIENT_ID = '898247770764-ev4i2nonvqnd4n8evrnivt75i2t78s0u.apps.googleusercontent.com'; // Google Cloud Console에서 발급받은 클라이언트 ID를 입력하세요.
        const API_KEY = 'AIzaSyBV_qqUNlgCkRAt7sITJbzxt38I3gZ5Z-4';     // Google Cloud Console에서 발급받은 API 키를 입력하세요.
        const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
        const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // 원본 매니저 및 사이트 목록 (검색 필터링용)
        let originalManagers = [];
        let originalSites = [];
        // 원본 보고서 시트 이름 목록 (검색 필터링용)
        let originalReportSheetNames = [];
        
        // L40 이후 범위의 사이트들 (고객 요청사항 입력 불가) - 동적으로 생성됨
        let sitesWithoutCustomerRequests = [];

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: DISCOVERY_DOCS,
            });
            // Sheets API를 명시적으로 로드합니다.
            await gapi.client.load('sheets', 'v4');
            gapiInited = true;
            maybeEnableForm();
        }

        function gisLoaded() {
            console.log('🔧 GIS (Google Identity Services) 로드됨');
            console.log('🔧 CLIENT_ID:', CLIENT_ID);
            console.log('🔧 SCOPES:', SCOPES);
            console.log('🔧 현재 URL:', window.location.href);
            console.log('🔧 현재 Origin:', window.location.origin);
            
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (resp) => {
                    console.log('🔧 OAuth 콜백 응답:', resp);
                    if (resp.error !== undefined) {
                        console.error('❌ OAuth 오류:', resp.error);
                        console.error('❌ 오류 상세:', resp.error_description);
                        console.error('❌ 전체 응답:', resp);
                        throw (resp);
                    }
                    console.log('✅ OAuth 성공, 토큰 설정');
                    gapi.client.setToken(resp);
                },
            });
            gisInited = true; // 이 부분을 callback 밖으로 이동
            maybeEnableForm(); // 이 부분을 callback 밖으로 이동
        }

        function maybeEnableForm() {
            console.log('maybeEnableForm called.'); // maybeEnableForm 함수 호출 로그 추가
            console.log('gapiInited:', gapiInited, 'gisInited:', gisInited); // gapiInited, gisInited 상태 로그 추가
            if (gapiInited && gisInited) {
                // 폼을 활성화하고 드롭다운 데이터를 로드합니다.
                // populateDropdowns()는 이제 조회 버튼 클릭 시 호출됩니다.
                document.getElementById('queryDropdownsButton').disabled = false;
                document.querySelector('button[type="submit"]').disabled = false;
                console.log('Dropdowns and Submit buttons enabled.'); // 버튼 활성화 로그 추가
                updateReadReportButtonState(); // 초기 로드 시 보고서 조회 버튼 상태 설정
                updateConfirmSiteButtonState(); // 초기 로드 시 "고정/선택" 버튼 상태 설정
            } else {
                console.log('Dropdowns and Submit buttons NOT yet enabled (waiting for gapi/gis init).'); // 버튼 비활성화 상태 로그 추가
            }
        }

        async function populateDropdowns() {
            console.log('🔧 populateDropdowns 함수 시작');
            console.log('🔧 gapi.client 상태:', gapi.client);
            console.log('🔧 현재 토큰:', gapi.client.getToken());
            const managerSelect = document.getElementById('manager');
            const siteSelect = document.getElementById('site_name');
            const reportSheetNameSelect = document.getElementById('reportSheetName');
            const queryButton = document.getElementById('queryDropdownsButton');

            // 버튼 상태를 로딩 중으로 변경
            queryButton.textContent = '로딩 중...';
            queryButton.style.backgroundColor = '#ffc107'; // 로딩 중 색상 (예: 주황색)
            queryButton.disabled = true;

            // 기존 옵션 제거 (첫 번째 '선택하세요' 옵션 제외)
            managerSelect.innerHTML = '<option value="">선택하세요</option>';
            siteSelect.innerHTML = '<option value="">선택하세요</option>';
            reportSheetNameSelect.innerHTML = '<option value="">선택하세요</option>';

            const SPREADSHEET_ID = '1Xrz9RlDXu3v6pBbuQc-B306gtXnG5CfebRG6KP44Kxs'; // 제공된 스프레드시트 ID
            const DROPDOWN_SHEET_NAME = 'SITE 분장 현황'; // 드롭다운 데이터가 있는 시트 이름
            const DROPDOWN_RANGE = `${DROPDOWN_SHEET_NAME}!A:Z`; // 충분히 넓은 범위로 데이터를 가져옵니다。

            try {
                console.log('Requesting dropdown data from Google Sheets API...');
                console.log('Spreadsheet ID:', SPREADSHEET_ID);
                console.log('Range:', DROPDOWN_RANGE);

                // 드롭다운 데이터 가져오기
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: DROPDOWN_RANGE,
                });

                console.log('Google Sheets API Response (Dropdown Data):', response); // API 응답 출력

                const sheetData = response.result.values || [];
                console.log('Extracted sheetData:', sheetData); // 추출된 sheetData 출력

                const managers = new Set();
                const sites = new Set();

                // '성명' 헤더가 있는 행을 건너뛰고 실제 데이터가 시작하는 행부터 처리
                for (let r = 0; r < sheetData.length; r++) {
                    const rowData = sheetData[r] || [];
                    const managerCell = rowData[1] ? rowData[1].trim() : ''; // Column B (index 1) for manager names

                    if (managerCell && managerCell !== '성명') {
                        managers.add(managerCell);
                    }

                    // Sites start from Column E (index 4)
                    for (let c = 4; c < rowData.length; c++) {
                        const siteCell = rowData[c] ? rowData[c].trim() : '';
                        if (siteCell !== '') {
                            sites.add(siteCell);
                        }
                    }
                }

                originalManagers = Array.from(managers).sort();
                // originalSites = Array.from(sites).sort(); // SITE 분장 현황에서 사이트 가져오는 로직 주석 처리
                console.log('Original Managers:', originalManagers); // 원본 매니저 목록 출력
                // console.log('Original Sites:', originalSites);     // 원본 사이트 목록 출력 (임시 주석 처리)

                // 매니저 드롭다운 채우기
                updateManagerDropdown(originalManagers);

                // 스프레드시트 메타데이터 가져와서 YYYY-MM-DD 형식의 시트 이름 찾기
                console.log('Requesting spreadsheet metadata...');
                const spreadsheetMetadataResponse = await gapi.client.sheets.spreadsheets.get({
                    spreadsheetId: SPREADSHEET_ID,
                });
                console.log('Google Sheets API Response (Spreadsheet Metadata):', spreadsheetMetadataResponse);

                // YYYY-MM-DD 형식의 시트 이름 필터링
                const datePattern = /^\d{4}-\d{2}-\d{2}$/;
                originalReportSheetNames = spreadsheetMetadataResponse.result.sheets
                    .filter(sheet => datePattern.test(sheet.properties.title))
                    .map(sheet => ({
                        title: sheet.properties.title,
                        id: sheet.properties.sheetId  // sheetId 대신 id로 변경
                    }))
                    .sort((a, b) => b.title.localeCompare(a.title)); // 최신 날짜가 먼저 오도록 정렬

                // 보고서 시트 이름 가져오기 및 채우기
                console.log('Original Report Sheet Names with IDs:', originalReportSheetNames); // 원본 시트 이름 목록과 ID 출력
                updateReportSheetNameDropdown(originalReportSheetNames);

                // --- 이제 가장 최신 YYYY-MM-DD 시트에서 SITE명 가져오기 ---
                if (originalReportSheetNames.length > 0) {
                    const latestReportSheetName = originalReportSheetNames[0].title; // 가장 최신 시트 (정렬되어 있음)
                    console.log('Fetching site names from latest report sheet:', latestReportSheetName);

                    // 사용자 제공 패턴에 따른 SITE명 셀 범위 (전체 범위로 확장)
                    const siteNameRanges = [
                        `'${latestReportSheetName}'!B:B`, // B열 전체에서 SITE명 찾기
                        `'${latestReportSheetName}'!G:G`, // G열 전체에서 SITE명 찾기
                        `'${latestReportSheetName}'!L:L`, // L열 전체에서 SITE명 찾기
                    ];

                    try {
                        const siteResponse = await gapi.client.sheets.spreadsheets.values.batchGet({
                            spreadsheetId: SPREADSHEET_ID,
                            ranges: siteNameRanges,
                        });
                        console.log('Site Names Batch Get Response:', siteResponse);

                        const fetchedSites = new Set();
                        const lColumnSitesWithoutCustomerRequests = new Set(); // L열의 40행 이후 사이트들
                        
                        siteResponse.result.valueRanges.forEach((rangeData, rangeIndex) => {
                            if (rangeData.values) {
                                rangeData.values.forEach((row, rowIndex) => {
                                    if (row.length > 0 && row[0] && row[0].trim() !== '') {
                                        const cellValue = row[0].trim();
                                        // 헤더나 설명 텍스트가 아닌 실제 사이트명만 필터링
                                        if (cellValue !== 'SITE명' && 
                                            !cellValue.includes('금주 한 일') && 
                                            !cellValue.includes('차주 할 일') && 
                                            !cellValue.includes('고객 요청사항') &&
                                            !cellValue.includes('본인 성명') &&
                                            !cellValue.includes('필수 입력') &&
                                            !cellValue.includes('없음') &&
                                            !cellValue.includes('▶') &&
                                            !cellValue.includes('구분') &&
                                            !cellValue.includes('작성 등록일') &&
                                            !cellValue.includes('매주 목요일') &&
                                            !cellValue.includes('휴일은 전일') &&
                                            !cellValue.includes('각 항목') &&
                                            !cellValue.includes('작성 내용이 없으면') &&
                                            !cellValue.includes('SITE명 순서') &&
                                            !cellValue.includes('프로젝트 순 표시') &&
                                            !cellValue.includes('25년 현재') &&
                                            !cellValue.includes('추진 中 프로젝트') &&
                                            rowIndex >= 3) { // 4행부터 시작 (0-based이므로 3)
                                            
                                            fetchedSites.add(cellValue);
                                            
                                            // L열(rangeIndex === 2)이고 40행 이후(rowIndex >= 39, 0-based이므로 40행은 39)인 경우
                                            if (rangeIndex === 2 && rowIndex >= 39) {
                                                lColumnSitesWithoutCustomerRequests.add(cellValue);
                                                console.log(`L열 40행 이후 사이트 발견: ${cellValue} (행: ${rowIndex + 1})`);
                                            }
                                        }
                                    }
                                });
                            }
                        });
                        
                        // L열 40행 이후 사이트들을 예외 목록에 추가
                        sitesWithoutCustomerRequests = Array.from(lColumnSitesWithoutCustomerRequests);
                        console.log('동적으로 생성된 예외 사이트 목록:', sitesWithoutCustomerRequests);
                        originalSites = Array.from(fetchedSites).sort();
                        console.log('Original Sites from latest report sheet:', originalSites); // 새로 가져온 사이트 목록 출력

                    } catch (siteErr) {
                        console.error('Error fetching site names from latest report sheet:', siteErr);
                        // 오류 발생 시 사이트 목록을 비워둠
                        originalSites = [];
                    }
                } else {
                    console.log('No YYYY-MM-DD report sheets found, cannot fetch site names.');
                    originalSites = [];
                }

                // 사이트 드롭다운 채우기
                updateSiteDropdown(originalSites, document.getElementById('searchSite').value);
                
                // 초기 상태에서 고객 요청사항 필드 상태 설정
                toggleCustomerRequestsField('');
                
                // 초기 상태에서 "고정/선택" 버튼 상태 설정
                updateConfirmSiteButtonState();

                // Google Sheets 링크 생성 (전체 스프레드시트)
                const mainSheetUrl = 'https://docs.google.com/spreadsheets/d/1Xrz9RlDXu3v6pBbuQc-B306gtXnG5CfebRG6KP44Kxs/edit';
                document.getElementById('response').innerHTML = `
                    매니저/사이트/시트 목록을 성공적으로 불러왔습니다.<br>
                    <a href="${mainSheetUrl}" target="_blank" style="color: #1976d2; text-decoration: underline; margin-top: 10px; display: inline-block;">
                        📊 Google Sheets에서 확인하기
                    </a>
                `;
                document.getElementById('response').style.display = 'block';

                // 드롭다운 조회 버튼 상태 변경
                queryButton.textContent = '조회 완료';
                queryButton.style.backgroundColor = '#6c757d'; // 회색 계열 색상
                queryButton.disabled = true; // 버튼 비활성화

            } catch (err) {
                console.error('Error fetching dropdown data (detailed):', err); // 상세 오류 출력
                document.getElementById('response').textContent = '드롭다운 데이터를 불러오는 데 실패했습니다: ' + (err.result?.error?.message || err.message || JSON.stringify(err));
                document.getElementById('response').style.display = 'block';

                // 오류 발생 시 버튼 상태를 초기화
                const queryButton = document.getElementById('queryDropdownsButton');
                queryButton.textContent = '매니저/사이트 목록 조회';
                queryButton.style.backgroundColor = '#4CAF50'; // 원래 색상
                queryButton.disabled = false; // 다시 활성화
            }
        }

        /**
         * 매니저 드롭다운을 업데이트합니다.
         * @param {Array<string>} managersList 표시할 매니저 목록
         */
        function updateManagerDropdown(managersList) {
            console.log('Updating Manager Dropdown with:', managersList); // 매니저 드롭다운 업데이트 전 목록 출력
            const managerSelect = document.getElementById('manager');
            managerSelect.innerHTML = '<option value="">선택하세요</option>'; // 기존 옵션 제거
            managersList.forEach(manager => {
                const option = document.createElement('option');
                option.value = manager;
                option.textContent = manager;
                managerSelect.appendChild(option);
            });
        }

        /**
         * 사이트 드롭다운을 업데이트합니다.
         * @param {Array<string>} sitesList 표시할 사이트 목록
         * @param {string} searchTerm 사이트 검색어 (현재는 사용하지 않음)
         */
        function updateSiteDropdown(sitesList, searchTerm = '') {
            console.log('Updating Site Dropdown with:', sitesList, 'Search Term:', searchTerm); // 사이트 드롭다운 업데이트 전 목록 출력
            const siteSelect = document.getElementById('site_name');
            siteSelect.innerHTML = '<option value="">선택하세요</option>'; // 기존 옵션 제거

            const filteredSites = sitesList.filter(site =>
                site.toLowerCase().includes(searchTerm.toLowerCase())
            ).sort();

            filteredSites.forEach(site => {
                const option = document.createElement('option');
                option.value = site;
                option.textContent = site;
                siteSelect.appendChild(option);
            });
        }

        /**
         * "고정/선택" 버튼의 활성화/비활성화 상태를 업데이트합니다.
         */
        function updateConfirmSiteButtonState() {
            const confirmButton = document.getElementById('confirmSiteButton');
            const managerSelected = document.getElementById('manager').value !== '';
            const siteSelected = document.getElementById('site_name').value !== '';
            const reportSheetSelected = document.getElementById('reportSheetName').value !== '';
            
            if (managerSelected && siteSelected && reportSheetSelected) {
                confirmButton.disabled = false;
                confirmButton.textContent = '고정/선택';
            } else {
                confirmButton.disabled = true;
                confirmButton.textContent = '고정/선택';
            }
        }

        /**
         * 선택된 사이트에 따라 고객 요청사항 필드를 활성화/비활성화합니다.
         * @param {string} selectedSite 선택된 사이트명
         */
        function toggleCustomerRequestsField(selectedSite) {
            const customerRequestsField = document.getElementById('customer_requests');
            const customerRequestsLabel = document.querySelector('label[for="customer_requests"]');
            
            console.log('toggleCustomerRequestsField called with:', selectedSite);
            console.log('Checking if site is in exception list...');
            
            if (sitesWithoutCustomerRequests.includes(selectedSite)) {
                // 고객 요청사항 입력 불가 사이트인 경우
                customerRequestsField.disabled = true;
                customerRequestsField.value = ''; // 기존 값 초기화
                customerRequestsField.placeholder = '해당 사이트는 고객 요청사항 입력이 불가합니다.';
                customerRequestsField.style.backgroundColor = '#f5f5f5';
                customerRequestsField.style.color = '#999';
                customerRequestsLabel.style.color = '#999';
                customerRequestsLabel.textContent = '고객 요청사항 (입력 불가)';
            } else {
                // 일반 사이트인 경우
                customerRequestsField.disabled = false;
                customerRequestsField.placeholder = '고객 요청사항을 입력하세요 (없으면 "없음" 입력)';
                customerRequestsField.style.backgroundColor = '';
                customerRequestsField.style.color = '';
                customerRequestsLabel.style.color = '';
                customerRequestsLabel.textContent = '고객 요청사항';
            }
        }

        /**
         * "고정/선택" 버튼 클릭 시 호출되는 함수
         */
        function confirmSiteSelection() {
            const managerSelected = document.getElementById('manager').value;
            const siteSelected = document.getElementById('site_name').value;
            const reportSheetSelected = document.getElementById('reportSheetName').value;
            const responseDiv = document.getElementById('response');
            
            // 모든 드롭다운이 선택되었는지 확인
            if (!managerSelected || !siteSelected || !reportSheetSelected) {
                responseDiv.textContent = '매니저, 담당 사이트, 보고서 시트 이름을 모두 선택해주세요.';
                responseDiv.style.display = 'block';
                responseDiv.style.backgroundColor = '#ffebee';
                responseDiv.style.color = '#c62828';
                return;
            }
            
            // 디버깅을 위한 로그 추가
            console.log('Selected site:', siteSelected);
            console.log('Sites without customer requests:', sitesWithoutCustomerRequests);
            console.log('Is site in exception list?', sitesWithoutCustomerRequests.includes(siteSelected));
            
            // 사이트 선택에 따라 고객 요청사항 필드 상태 설정
            toggleCustomerRequestsField(siteSelected);
            
            // Google Sheets 링크 생성 (선택된 보고서 시트에 따라)
            const selectedReportSheetName = document.getElementById('reportSheetName').value;
            const selectedOption = document.getElementById('reportSheetName').selectedOptions[0];
            const reportSheetId = selectedOption ? selectedOption.dataset.sheetId : '';
            const sheetUrl = `https://docs.google.com/spreadsheets/d/1Xrz9RlDXu3v6pBbuQc-B306gtXnG5CfebRG6KP44Kxs/edit#gid=${reportSheetId}`;
            
            // 성공 메시지 표시
            responseDiv.innerHTML = `
                사이트 선택이 확정되었습니다: ${siteSelected}<br>
                <a href="${sheetUrl}" target="_blank" style="color: #1976d2; text-decoration: underline; margin-top: 10px; display: inline-block;">
                    📊 Google Sheets에서 확인하기
                </a>
            `;
            responseDiv.style.display = 'block';
            responseDiv.style.backgroundColor = '#e8f5e8';
            responseDiv.style.color = '#2e7d32';
        }

        /**
         * 보고서 시트 이름 드롭다운을 업데이트합니다.
         * @param {Array<{title: string, id: number}>} sheetNamesList 표시할 시트 이름 및 ID 목록
         * @param {string} searchTerm 시트 이름 검색어 (현재는 사용하지 않음)
         */
        function updateReportSheetNameDropdown(sheetNamesList, searchTerm = '') {
            console.log('Updating Report Sheet Name Dropdown with:', sheetNamesList); // 시트 이름 드롭다운 업데이트 전 목록 출력
            const reportSheetNameSelect = document.getElementById('reportSheetName');
            reportSheetNameSelect.innerHTML = '<option value="">선택하세요</option>'; // 기존 옵션 제거

            // 검색 기능이 없으므로 모든 시트 이름 표시
            sheetNamesList.forEach(sheet => {
                const option = document.createElement('option');
                option.value = sheet.title;
                option.textContent = sheet.title;
                option.dataset.sheetId = sheet.id; // sheetId를 data-sheet-id 속성으로 저장
                reportSheetNameSelect.appendChild(option);
            });
        }

        // 매니저 검색 필드 이벤트 리스너
        document.getElementById('searchManager').addEventListener('keyup', function() {
            const searchTerm = this.value.toLowerCase();
            const filteredManagers = originalManagers.filter(manager =>
                manager.toLowerCase().includes(searchTerm)
            );
            console.log('Filtered Managers (searchManager keyup):', filteredManagers); // 매니저 검색 필터링 결과 출력
            updateManagerDropdown(filteredManagers);
            updateReadReportButtonState(); // 매니저 변경 시 보고서 조회 버튼 상태 업데이트
        });

        // 사이트 검색 필드 이벤트 리스너
        document.getElementById('searchSite').addEventListener('keyup', function() {
            const searchTerm = this.value.toLowerCase();
            updateSiteDropdown(originalSites, searchTerm); // 매니저 필터링 없이 전체 사이트에서 검색
            updateReadReportButtonState(); // 사이트 변경 시 보고서 조회 버튼 상태 업데이트
        });

        // 매니저 드롭다운 변경 시 보고서 조회 버튼 및 고정/선택 버튼 상태 업데이트
        document.getElementById('manager').addEventListener('change', function() {
            updateReadReportButtonState();
            updateConfirmSiteButtonState();
        });

        // 사이트 드롭다운 변경 시 보고서 조회 버튼 상태만 업데이트
        document.getElementById('site_name').addEventListener('change', function() {
            updateReadReportButtonState();
            updateConfirmSiteButtonState();
        });

        // 보고서 시트 이름 드롭다운 변경 시 보고서 조회 버튼 상태 업데이트
        document.getElementById('reportSheetName').addEventListener('change', function() {
            updateReadReportButtonState();
            updateConfirmSiteButtonState();
        });

        // "고정/선택" 버튼 클릭 이벤트 리스너
        document.getElementById('confirmSiteButton').addEventListener('click', confirmSiteSelection);

        // "보고서 조회" 버튼의 활성화/비활성화 상태를 업데이트하는 헬퍼 함수
        function updateReadReportButtonState() {
            const managerSelected = document.getElementById('manager').value !== '';
            const siteSelected = document.getElementById('site_name').value !== '';
            const reportSheetNameSelected = document.getElementById('reportSheetName').value !== '';
            const readReportButton = document.getElementById('readReportButton');

            if (managerSelected && siteSelected && reportSheetNameSelected) {
                readReportButton.disabled = false;
                readReportButton.style.backgroundColor = '#4CAF50'; // 원래 색상
            } else {
                readReportButton.disabled = true;
                readReportButton.style.backgroundColor = '#cccccc'; // 비활성화 색상
            }
        }

        document.getElementById('reportForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            if (!gapi.client.getToken()) {
                // 토큰이 없으면 승인 요청
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) {
                        throw (resp);
                    }
                    // 토큰 획득 후 폼 제출 재시도
                    submitFormData(event); // event 객체 전달
                };
                tokenClient.requestAccessToken();
            } else {
                // 토큰이 있으면 바로 폼 제출
                submitFormData(event); // event 객체 전달
            }
        });

        async function submitFormData(event) {
            const formData = {
                site_name: document.getElementById('site_name').value,
                manager: document.getElementById('manager').value,
                this_week_tasks: document.getElementById('this_week_tasks').value,
                next_week_tasks: document.getElementById('next_week_tasks').value,
                customer_requests: document.getElementById('customer_requests').value
            };

            console.log('Form Data:', formData);

            const responseDiv = document.getElementById('response');
            responseDiv.style.display = 'block';
            responseDiv.textContent = '보고서 제출 중...';

            // 보고서 시트 정보 가져오기
            const SPREADSHEET_ID = '1Xrz9RlDXu3v6pBbuQc-B306gtXnG5CfebRG6KP44Kxs'; // 스프레드시트 ID
            const REPORT_SHEET_NAME = document.getElementById('reportSheetName').value;
            const selectedOption = document.getElementById('reportSheetName').selectedOptions[0];
            const REPORT_SHEET_ID = selectedOption ? parseInt(selectedOption.dataset.sheetId) : null;
            
            // 디버깅을 위한 로그 추가
            console.log('Submit Form Data - Debug Info:');
            console.log('SPREADSHEET_ID:', SPREADSHEET_ID);
            console.log('REPORT_SHEET_NAME:', REPORT_SHEET_NAME);
            console.log('selectedOption:', selectedOption);
            console.log('REPORT_SHEET_ID:', REPORT_SHEET_ID);
            console.log('selectedOption.dataset.sheetId:', selectedOption ? selectedOption.dataset.sheetId : 'N/A');
            
            // 시트 ID가 없으면 오류 처리
            if (!REPORT_SHEET_ID) {
                console.error('REPORT_SHEET_ID is null or undefined');
                responseDiv.textContent = '보고서 시트 ID를 찾을 수 없습니다. 다시 시도해주세요.';
                return;
            }

            // 스프레드시트의 열 순서를 정의합니다. SITE명, 담당자, 금주 한 일 순서입니다.
            // 실제 스프레드시트의 열 순서와 일치해야 합니다.
            const COLUMN_ORDER = ['SITE명', '담당자', '금주 한 일']; 

            try {
                // 시트의 전체 데이터 가져오기
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `${REPORT_SHEET_NAME}!A:Z`, // 충분히 넓은 범위로 데이터를 가져옵니다。
                });

                const sheetData = response.result.values || [];

                // site_name 위치 찾기
                const { row, col } = findCellCoordinates(sheetData, formData.site_name, REPORT_SHEET_NAME, COLUMN_ORDER);

                if (row === -1 || col === -1) {
                    throw new Error(`담당 사이트 '${formData.site_name}'를 시트에서 찾을 수 없습니다.`);
                }

                const updates = []; // values.batchUpdate를 위한 업데이트 배열

                // 모든 셀에 적용할 공통 서식
                // const cellFormat = {
                //     textFormat: {
                //         fontSize: 11,
                //         bold: true,
                //         fontFamily: 'Arial' // 폰트 변질 방지를 위해 Arial 폰트 지정
                //     }
                // };

                // 담당자 셀 (site_name 셀의 행은 동일, 열은 바로 오른쪽)
                const managerColOffset = COLUMN_ORDER.indexOf('담당자');
                const managerRange = `'${REPORT_SHEET_NAME}'!${columnToLetter(col + managerColOffset)}${row + 1}`;
                updates.push({
                    range: managerRange,
                    values: [[formData.manager]]
                });

                // 금주 한 일 셀 (site_name 셀의 행은 동일, 열은 '금주 한 일'이 있는 열)
                let thisWeekTasksRelativeOffset = COLUMN_ORDER.indexOf('금주 한 일');
                thisWeekTasksRelativeOffset += 1; // N열에서 O열로 이동하기 위해 1 추가
                const thisWeekTasksRange = `'${REPORT_SHEET_NAME}'!${columnToLetter(col + thisWeekTasksRelativeOffset)}${row + 1}`;
                updates.push({
                    range: thisWeekTasksRange,
                    values: [[`▶ ${formData.this_week_tasks}`]]
                });

                // 차주 할 일 셀 (site_name 셀의 행은 아래로 1칸, 열은 '금주 한 일'과 동일)
                const nextWeekTasksRange = `'${REPORT_SHEET_NAME}'!${columnToLetter(col + thisWeekTasksRelativeOffset)}${row + 2}`;
                updates.push({
                    range: nextWeekTasksRange,
                    values: [[`▶ ${formData.next_week_tasks}`]]
                });

                // 고객 요청사항 셀 (site_name 셀의 행은 아래로 2칸, 열은 '금주 한 일'과 동일)
                // 예외 사이트가 아닌 경우에만 고객 요청사항 처리
                if (formData.customer_requests && !sitesWithoutCustomerRequests.includes(formData.site_name)) {
                    const customerRequestsRange = `'${REPORT_SHEET_NAME}'!${columnToLetter(col + thisWeekTasksRelativeOffset)}${row + 3}`;
                    updates.push({
                        range: customerRequestsRange,
                        values: [[`▶ ${formData.customer_requests}`]]
                    });
                }

                // batchUpdate 요청 (셀 값만 업데이트, 서식 유지)
                await gapi.client.sheets.spreadsheets.values.batchUpdate({
                    spreadsheetId: SPREADSHEET_ID,
                    resource: {
                        data: updates,
                        valueInputOption: 'USER_ENTERED'
                    }
                });

                // Google Sheets 링크 생성
                const sheetUrl = `https://docs.google.com/spreadsheets/d/1Xrz9RlDXu3v6pBbuQc-B306gtXnG5CfebRG6KP44Kxs/edit#gid=${REPORT_SHEET_ID}`;
                responseDiv.innerHTML = `
                    보고서가 성공적으로 제출되었습니다!<br>
                    <a href="${sheetUrl}" target="_blank" style="color: #1976d2; text-decoration: underline; margin-top: 10px; display: inline-block;">
                        📊 Google Sheets에서 확인하기
                    </a>
                `;

                // 드롭다운 값 확인 (초기화되기 전)
                console.log('Manager dropdown value before clearing text fields:', document.getElementById('manager').value);
                console.log('Site dropdown value before clearing text fields:', document.getElementById('site_name').value);
                console.log('Report Sheet Name dropdown value before clearing text fields:', document.getElementById('reportSheetName').value);

                // 텍스트 필드만 초기화
                document.getElementById('this_week_tasks').value = '';
                document.getElementById('next_week_tasks').value = '';
                document.getElementById('customer_requests').value = '';

            } catch (err) {
                console.error('Error submitting report:', err);
                responseDiv.textContent = '보고서 제출 중 오류가 발생했습니다: ' + (err.result?.error?.message || err.message);
            }
        }

        async function readReportData() {
            console.log('readReportData function called.');
            const readReportButton = document.getElementById('readReportButton');
            const responseDiv = document.getElementById('response');

            // 버튼 상태를 로딩 중으로 변경
            readReportButton.textContent = '로딩 중...';
            readReportButton.style.backgroundColor = '#ffc107'; // 로딩 중 색상 (예: 주황색)
            readReportButton.disabled = true;
            responseDiv.style.display = 'block';
            responseDiv.textContent = '보고서 데이터 조회 중...';

            const SPREADSHEET_ID = '1Xrz9RlDXu3v6pBbuQc-B306gtXnG5CfebRG6KP44Kxs';
            const selectedManager = document.getElementById('manager').value;
            const selectedSiteName = document.getElementById('site_name').value;
            const selectedReportSheetName = document.getElementById('reportSheetName').value;

            if (!selectedManager || !selectedSiteName || !selectedReportSheetName) {
                responseDiv.textContent = '매니저, 담당 사이트, 보고서 시트 이름을 모두 선택해주세요.';
                readReportButton.textContent = '보고서 조회';
                readReportButton.style.backgroundColor = '#4CAF50';
                readReportButton.disabled = false;
                return;
            }

            // 스프레드시트의 열 순서를 정의합니다. (데이터 쓰기와 동일)
            const COLUMN_ORDER = ['SITE명', '담당자', '금주 한 일'];

            try {
                // 시트의 전체 데이터 가져오기 (site_name 위치 찾기 위함)
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `${selectedReportSheetName}!A:Z`,
                });
                const sheetData = response.result.values || [];

                // site_name 위치 찾기
                const { row, col } = findCellCoordinates(sheetData, selectedSiteName, selectedReportSheetName, COLUMN_ORDER);

                if (row === -1 || col === -1) {
                    throw new Error(`담당 사이트 '${selectedSiteName}'를 시트에서 찾을 수 없습니다.`);
                }

                // 읽어올 셀 범위 계산 (쓰기 위치와 동일하게)
                let thisWeekTasksRelativeOffset = COLUMN_ORDER.indexOf('금주 한 일');
                thisWeekTasksRelativeOffset += 1; // O열로 이동하기 위해 1 추가

                // 예외 사이트에 따라 읽어올 범위 결정
                const rangesToRead = [
                    `'${selectedReportSheetName}'!${columnToLetter(col + thisWeekTasksRelativeOffset)}${row + 1}`, // 금주 한 일
                    `'${selectedReportSheetName}'!${columnToLetter(col + thisWeekTasksRelativeOffset)}${row + 2}`  // 차주 할 일
                ];
                
                // 예외 사이트가 아닌 경우에만 고객 요청사항 범위 추가
                if (!sitesWithoutCustomerRequests.includes(selectedSiteName)) {
                    rangesToRead.push(`'${selectedReportSheetName}'!${columnToLetter(col + thisWeekTasksRelativeOffset)}${row + 3}`); // 고객 요청사항
                }

                console.log('Reading data from ranges:', rangesToRead);

                const readResponse = await gapi.client.sheets.spreadsheets.values.batchGet({
                    spreadsheetId: SPREADSHEET_ID,
                    ranges: rangesToRead,
                });
                console.log('Read API Response:', readResponse);

                const values = readResponse.result.valueRanges || [];

                // 텍스트 필드에 데이터 출력
                document.getElementById('this_week_tasks').value = (values[0] && values[0].values && values[0].values[0]) ? values[0].values[0][0].replace(/^▶\s*/, '') : '';
                document.getElementById('next_week_tasks').value = (values[1] && values[1].values && values[1].values[0]) ? values[1].values[0][0].replace(/^▶\s*/, '') : '';
                
                // 예외 사이트가 아닌 경우에만 고객 요청사항 읽기
                if (!sitesWithoutCustomerRequests.includes(selectedSiteName)) {
                    // 예외 사이트가 아닌 경우 values[2]가 고객 요청사항
                    document.getElementById('customer_requests').value = (values[2] && values[2].values && values[2].values[0]) ? values[2].values[0][0].replace(/^▶\s*/, '') : '';
                } else {
                    document.getElementById('customer_requests').value = ''; // 예외 사이트는 빈 값으로 설정
                }

                // Google Sheets 링크 생성 (선택된 보고서 시트에 따라)
                const selectedOption = document.getElementById('reportSheetName').selectedOptions[0];
                const reportSheetId = selectedOption ? selectedOption.dataset.sheetId : '';
                const sheetUrl = `https://docs.google.com/spreadsheets/d/1Xrz9RlDXu3v6pBbuQc-B306gtXnG5CfebRG6KP44Kxs/edit#gid=${reportSheetId}`;
                responseDiv.innerHTML = `
                    보고서 데이터를 성공적으로 조회했습니다!<br>
                    <a href="${sheetUrl}" target="_blank" style="color: #1976d2; text-decoration: underline; margin-top: 10px; display: inline-block;">
                        📊 Google Sheets에서 확인하기
                    </a>
                `;
                readReportButton.textContent = '조회 완료';
                readReportButton.style.backgroundColor = '#6c757d';
                // 조회 완료 후에도 다시 조회할 수 있도록 활성화 상태 유지
                readReportButton.disabled = false; 

                // 3초 뒤 버튼 상태 초기화
                setTimeout(() => {
                    readReportButton.textContent = '보고서 조회';
                    readReportButton.style.backgroundColor = '#4CAF50'; // 원래 색상
                    readReportButton.disabled = false;
                }, 3000); // 3초 (3000ms)

            } catch (err) {
                console.error('Error reading report data:', err);
                responseDiv.textContent = '보고서 데이터 조회 중 오류가 발생했습니다: ' + (err.result?.error?.message || err.message || JSON.stringify(err));
                readReportButton.textContent = '보고서 조회';
                readReportButton.style.backgroundColor = '#dc3545'; // 오류 시 빨간색
                readReportButton.disabled = false;
            }
        }

        document.getElementById('queryDropdownsButton').addEventListener('click', populateDropdowns);

        // 보고서 조회 버튼 이벤트 리스너
        document.getElementById('readReportButton').addEventListener('click', readReportData);

        // 사용법 팝업 이벤트 리스너
        const helpButton = document.getElementById('helpButton');
        const helpModal = document.getElementById('helpModal');
        const closeButton = document.querySelector('.close');

        helpButton.addEventListener('click', function() {
            helpModal.style.display = 'block';
        });

        closeButton.addEventListener('click', function() {
            helpModal.style.display = 'none';
        });

        // 배경 클릭 시 모달 닫기
        window.addEventListener('click', function(event) {
            if (event.target === helpModal) {
                helpModal.style.display = 'none';
            }
        });

        // ESC 키로 모달 닫기
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && helpModal.style.display === 'block') {
                helpModal.style.display = 'none';
            }
        });

        /**
         * 시트 데이터에서 특정 site_name을 찾아 해당 셀의 0-based 행과 열 인덱스를 반환합니다.
         * site_name은 'SITE명' 열(B열, G열, L열 등)에 위치한다고 가정합니다.
         * @param {Array<Array<string>>} sheetData 시트의 전체 2차원 배열 데이터
         * @param {string} siteName 찾을 site_name
         * @param {string} sheetName 현재 시트 이름
         * @param {Array<string>} columnOrder 스프레드시트의 열 순서 (예: ['SITE명', '담당자', '금주 한 일'])
         * @returns {{row: number, col: number}} site_name이 발견된 0-based 행 및 열 인덱스. 찾지 못하면 {row: -1, col: -1}.
         */
        function findCellCoordinates(sheetData, siteName, sheetName, columnOrder) {
            const siteNameColIndexInOrder = columnOrder.indexOf('SITE명');
            
            for (let r = 0; r < sheetData.length; r++) {
                const row = sheetData[r];
                for (let c = 0; c < row.length; c++) {
                    // SITE명 열에 해당하는 경우에만 검색
                    // 여기서는 columnOrder의 'SITE명'이 실제 Sheets의 어느 열에 해당하는지를 알아야 합니다.
                    // 간단화를 위해, 실제 Sheets에서 SITE명이 특정 열에 규칙적으로 나타난다고 가정합니다.
                    // 예를 들어, B, G, L 열에 SITE명이 있다면, c % 5 === 1 (0-based) 과 같은 규칙을 사용할 수 있습니다.
                    // 현재는 모든 셀을 검색합니다. 보다 정확한 로직이 필요하면 수정해야 합니다.
                    if (row[c] === siteName) {
                         // 여기서 `c`는 site_name이 발견된 실제 0-based 열 인덱스입니다。
                         // 이 `c`를 기준으로 다른 컬럼의 오프셋을 계산합니다.
                        return { row: r, col: c };
                    }
                }
            }
            return { row: -1, col: -1 };
        }

        /**
         * 0-based 열 인덱스를 A1 표기법의 열 문자(예: 0 -> A, 25 -> Z, 26 -> AA)로 변환합니다.
         * @param {number} colIndex 0-based 열 인덱스
         * @returns {string} A1 표기법 열 문자
         */
        function columnToLetter(colIndex) {
            let temp, letter = '';
            while (colIndex >= 0) {
                temp = colIndex % 26;
                letter = String.fromCharCode(temp + 65) + letter;
                colIndex = Math.floor(colIndex / 26) - 1;
            }
            return letter;
        }
    </script>

    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
